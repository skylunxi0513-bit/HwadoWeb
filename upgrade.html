<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>강화/증폭 시뮬레이터 - 화도웹</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .simulator-container {
            width: 100%;
            max-width: 400px; 
            margin: 20px auto;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
            transition: background-color 0.1s ease-in-out;
        }
        .simulator-container.success-flash {
            background-color: #a8e6a8; 
        }
        .simulator-container.failure-flash {
            background-color: #e6a8a8; 
        }
        .simulator-container.destroyed-flash {
            background-color: #cccccc; 
        }
        .user-display {
            text-align: right;
            margin-bottom: 15px;
            font-size: 14px;
            color: #555;
        }
        .mode-selector {
            margin-bottom: 10px;
        }
        .mode-selector button {
            width: 120px;
        }
        #secret-container {
            margin-bottom: 20px;
            display: none; /* Hidden by default */
        }
        .image-box {
            width: 100%;
            height: 200px; 
            border: 2px dashed #ccc;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f9f9f9;
            overflow: hidden; 
        }
        .image-box img {
            max-width: 100%;
            max-height: 100%;
            transform: scale(2.5); 
        }
        .level-display {
            font-size: 48px;
            font-weight: bold;
            color: #007bff;
            margin-bottom: 20px;
        }
        .level-display.destroyed {
            color: #888;
        }
        .info-grid {
            display: flex;
            justify-content: space-between;
            text-align: left;
            margin-bottom: 20px;
            padding: 0 10px;
        }
        .probability-display p, .current-cost-display p {
            margin: 5px 0;
        }
        .current-cost-display {
            text-align: right;
        }
        .action-button {
            width: 100%;
            padding: 15px;
            font-size: 20px;
            margin-bottom: 20px;
        }
        .cumulative-cost-display {
            font-size: 16px;
            color: #555;
            border-top: 1px solid #eee;
            padding-top: 15px;
            transition: all 0.2s ease-in-out;
        }
        .cumulative-cost-display.destroyed-style {
            font-size: 20px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <a href="index.html" class="header-link">
        <h1>화도웹</h1>
    </a>

    <div class="simulator-container" id="simulator-container">
        <div class="user-display">
            사용자: <span id="username-display">비회원</span>
        </div>

        <div class="mode-selector">
            <button id="refine-btn">강화</button>
            <button id="amplify-btn" disabled>증폭</button>
        </div>

        <div id="secret-container">
            <input type="checkbox" id="secret-checkbox">
            <label for="secret-checkbox">강화의 비밀</label>
        </div>

        <div class="image-box" id="image-box">
            <img id="item-image" src="" alt="아이템 이미지">
        </div>

        <div class="level-display" id="level-display">+0</div>

        <div class="info-grid">
            <div class="probability-display">
                <p>성공 확률: <span id="success-chance">-</span>%</p>
                <p>실패 확률: <span id="failure-chance">-</span>%</p>
                <p>파괴 확률: <span id="destroy-chance">-</span>%</p>
            </div>
            <div class="current-cost-display">
                <p><span id="current-gold-cost">-</span> 골드</p>
            </div>
        </div>

        <button class="action-button" id="action-button">강화</button>

        <div class="cumulative-cost-display" id="cumulative-cost-display">
            <p>누적 소모 골드: <span id="total-gold-cost">0</span></p>
        </div>
    </div>

    <script>
        // --- STATE ---
        let currentLevel = 0;
        let totalGold = 0;
        let isDestroyed = false;
        let refineData = [];
        let bonusChances = {};
        let currentUser = '비회원';
        let hasUnlockedSecret = false;

        // --- DOM Elements ---
        const simulatorContainer = document.getElementById('simulator-container');
        const usernameDisplay = document.getElementById('username-display');
        const secretContainer = document.getElementById('secret-container');
        const secretCheckbox = document.getElementById('secret-checkbox');
        const levelDisplay = document.getElementById('level-display');
        const itemImage = document.getElementById('item-image');
        const imageBox = document.getElementById('image-box');
        const actionButton = document.getElementById('action-button');
        const successChanceEl = document.getElementById('success-chance');
        const failureChanceEl = document.getElementById('failure-chance');
        const destroyChanceEl = document.getElementById('destroy-chance');
        const currentGoldCostEl = document.getElementById('current-gold-cost');
        const totalGoldCostEl = document.getElementById('total-gold-cost');
        const cumulativeCostDisplay = document.getElementById('cumulative-cost-display');

        // --- LOGIC ---
        function getImagePath(level) {
            if (level >= 0 && level <= 4) return '0004.png';
            if (level >= 5 && level <= 9) return '0509.png';
            if (level >= 10 && level <= 12) return '1012.png';
            if (level === 13) return '1313.png';
            if (level === 14) return '1414.png';
            if (level === 15) return '1515.png';
            if (level === 16) return '1616.png';
            if (level >= 17) return '1717.png';
            return '0004.png';
        }

        function flashEffect(type) {
            const className = `${type}-flash`;
            simulatorContainer.classList.add(className);
            setTimeout(() => {
                simulatorContainer.classList.remove(className);
            }, 500);
        }

        function updateUI() {
            if (isDestroyed) {
                levelDisplay.textContent = 'DESTROYED';
                levelDisplay.classList.add('destroyed');
                imageBox.style.display = 'none';
                actionButton.textContent = '재시도';
                successChanceEl.textContent = '-';
                failureChanceEl.textContent = '-';
                destroyChanceEl.textContent = '-';
                currentGoldCostEl.textContent = '-';
                cumulativeCostDisplay.classList.add('destroyed-style');
                return;
            }

            if (hasUnlockedSecret) {
                secretContainer.style.display = 'block';
            }

            cumulativeCostDisplay.classList.remove('destroyed-style');
            levelDisplay.classList.remove('destroyed');
            imageBox.style.display = 'flex';
            actionButton.textContent = '강화';

            levelDisplay.textContent = `+${currentLevel}`;
            itemImage.src = `images/upgrade/01/${getImagePath(currentLevel)}`;

            const data = refineData.find(row => parseInt(row[0]) === currentLevel);
            if (data) {
                const baseSuccess = parseFloat(data[1] || 0);
                const bonusSuccess = bonusChances[currentLevel] || 0;
                const secretBonus = secretCheckbox.checked ? 1 : 0;
                const actualSuccess = baseSuccess + bonusSuccess + secretBonus;
                const cost = parseInt(data[2] || 0);
                const penalty = parseInt(data[3] || 0);
                const isDestructible = penalty === -100;
                const failure = 100 - actualSuccess;

                successChanceEl.textContent = actualSuccess.toFixed(2);
                failureChanceEl.textContent = isDestructible ? '0.00' : failure.toFixed(2);
                destroyChanceEl.textContent = isDestructible ? failure.toFixed(2) : '0.00';
                currentGoldCostEl.textContent = cost.toLocaleString();
                actionButton.disabled = false;
            } else {
                successChanceEl.textContent = '0.00';
                failureChanceEl.textContent = '0.00';
                destroyChanceEl.textContent = '0.00';
                currentGoldCostEl.textContent = '-';
                actionButton.disabled = true;
            }

            totalGoldCostEl.textContent = totalGold.toLocaleString();
        }

        async function submitRanking() {
            if (currentUser === '비회원') return;
            try {
                await fetch('/.netlify/functions/addRank', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ nickname: currentUser, level: currentLevel, gold: totalGold, password: '0305' })
                });
            } catch (error) {
                console.error('Rank submission error:', error);
            }
        }

        function handleRefine() {
            if (isDestroyed) {
                resetSimulator();
                return;
            }

            const data = refineData.find(row => parseInt(row[0]) === currentLevel);
            if (!data) return;

            const baseSuccess = parseFloat(data[1] || 0);
            const bonusSuccess = bonusChances[currentLevel] || 0;
            const secretBonus = secretCheckbox.checked ? 1 : 0;
            const actualSuccess = baseSuccess + bonusSuccess + secretBonus;
            const cost = parseInt(data[2] || 0);
            const penalty = parseInt(data[3] || 0);
            const correctionChance = parseFloat(data[4] || 0);

            totalGold += cost;

            const roll = Math.random() * 100;

            if (roll < actualSuccess) {
                flashEffect('success');
                bonusChances[currentLevel] = 0;
                currentLevel++;
            } else {
                if (penalty === -100) {
                    flashEffect('destroyed');
                    if (currentLevel >= 12) {
                        hasUnlockedSecret = true;
                    }
                    isDestroyed = true;
                    submitRanking();
                } else {
                    flashEffect('failure');
                    bonusChances[currentLevel] = (bonusChances[currentLevel] || 0) + correctionChance;
                    currentLevel = Math.max(0, currentLevel - Math.abs(penalty));
                }
            }
            updateUI();
        }

        function resetSimulator() {
            currentLevel = 0;
            totalGold = 0;
            isDestroyed = false;
            bonusChances = {};
            actionButton.disabled = false;
            updateUI();
        }

        async function initialize() {
            currentUser = sessionStorage.getItem('simulatorUser') || '비회원';
            usernameDisplay.textContent = currentUser;

            if (currentUser !== '비회원') {
                try {
                    const res = await fetch(`/.netlify/functions/sheets?query=checkRank&nickname=${encodeURIComponent(currentUser)}`);
                    const data = await res.json();
                    if (data.unlocked) {
                        hasUnlockedSecret = true;
                    }
                } catch (e) {
                    console.error('Could not check rank:', e);
                }
            }

            try {
                const response = await fetch(`/.netlify/functions/sheets?sheetName=강화확률`);
                if (!response.ok) throw new Error(`Sheets API Error`);
                const result = await response.json();
                if (result.error) throw new Error(result.error);
                refineData = result.data;
                resetSimulator();
            } catch (error) {
                console.error("Failed to load spreadsheet data:", error);
                levelDisplay.textContent = "오류";
            }
        }

        secretCheckbox.addEventListener('change', updateUI);
        actionButton.addEventListener('click', handleRefine);

        initialize();

    </script>
</body>
</html>
