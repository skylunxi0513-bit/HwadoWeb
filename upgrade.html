<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>강화/증폭 시뮬레이터 - 화도웹</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .simulator-container { max-width: 450px; margin: 20px auto; padding: 20px; background-color: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center; transition: background-color 0.1s ease-in-out; }
        .simulator-container.success-flash { background-color: #a8e6a8; }
        .simulator-container.failure-flash { background-color: #e6a8a8; }
        .simulator-container.destroyed-flash { background-color: #cccccc; }
        .simulator-container.ticket-success-flash { background-color: #fffacd; }
        .user-display-container { position: relative; }
        .user-display { text-align: right; margin-bottom: 15px; font-size: 14px; color: #555; cursor: help; }
        .mode-selector { margin-bottom: 10px; }
        .mode-selector button { width: 220px; padding: 15px; font-size: 16px; }
        .perks-container { margin-bottom: 20px; text-align: center; min-height: 58.5px; }
        .perk-item-group { display: flex; justify-content: center; gap: 20px; margin-bottom: 10px; }
        .perk-item { display: none; align-items: center; gap: 5px; }
        .perk-item label { cursor: help; }
        #autoticket-container, #amplify-autoticket-container, #amplify-frenzy-container { display: none; text-align: center; }
        .image-box { width: 100%; height: 200px; border: 2px dashed #ccc; margin-bottom: 20px; display: flex; align-items: center; justify-content: center; background-color: #f9f9f9; overflow: hidden; }
        .image-box img { max-width: 100%; max-height: 100%; transform: scale(2.5); }
        .level-display { font-size: 48px; font-weight: bold; color: #007bff; margin-bottom: 20px; line-height: 1.2; }
        .level-display.amplify { color: #8A2BE2; }
        .level-display.destroyed { color: #888; }
        .level-display .final-level-text { font-size: 24px; font-weight: normal; color: #6c757d; }
        .info-grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; text-align: left; margin-bottom: 20px; padding: 10px; border: 1px solid #eee; border-radius: 8px; }
        .info-grid-container h4 { margin: 0 0 5px 0; text-align: center; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .info-grid-container p { margin: 5px 0; font-size: 14px; }
        .info-grid-container .cost { font-weight: bold; color: #c0392b; }
        .button-container { display: flex; gap: 10px; }
        .action-button { width: 100%; padding: 15px; font-size: 20px; margin-bottom: 20px; flex-grow: 1; }
        .action-button:disabled { background-color: #e0e0e0; cursor: not-allowed; }
        .cumulative-cost-display { font-size: 16px; color: #555; border-top: 1px solid #eee; padding-top: 15px; transition: all 0.2s ease-in-out; }
        .cumulative-cost-display.destroyed-style { font-size: 20px; font-weight: bold; }
        #tooltip { position: absolute; background-color: #333; color: #fff; padding: 10px; border-radius: 5px; z-index: 1000; text-align: left; min-width: 250px; max-width: 300px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); display: none; pointer-events: none; }
        #tooltip h4 { margin: 0 0 8px 0; font-size: 14px; color: #f0f0f0; border-bottom: 1px solid #555; padding-bottom: 5px; }
        #tooltip p { margin: 4px 0; font-size: 12px; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <a href="index.html" class="header-link"><h1>화도웹</h1></a>
    <div class="simulator-container" id="simulator-container">
        <div class="simulator-header">
            <a href="statistics.html" class="stats-link"><button>통계</button></a>
            <div class="user-display-container" id="user-display-container"><div class="user-display">사용자: <span id="username-display"></span></div></div>
        </div>
        <div class="mode-selector">
            <button id="refine-btn">강화</button>
            <button id="amplify-btn">증폭</button>
        </div>

        <!-- 강화 모드 -->
        <div id="refine-mode-container">
            <div class="perks-container">
                <div class="perk-item-group">
                    <div class="perk-item" id="secret-container"><input type="checkbox" id="secret-checkbox"><label for="secret-checkbox">강화의 비밀</label></div>
                    <div class="perk-item" id="costume-container"><input type="checkbox" id="costume-checkbox"><label for="costume-checkbox">화덕 변신 코스튬</label></div>
                </div>
                <div class="perk-item" id="autoticket-container"><input type="checkbox" id="autoticket-checkbox"><label for="autoticket-checkbox">강화권 자동 사용</label></div>
            </div>
            <div class="image-box" id="refine-image-box"><img id="refine-item-image" src="" alt="아이템 이미지"></div>
            <div class="level-display" id="refine-level-display">+0</div>
            <div class="info-grid-container">
                <div id="normal-refine-info"><h4>일반 강화</h4><p>성공 확률: <span id="refine-success-chance">-</span>%</p><p>실패 확률: <span id="refine-failure-chance">-</span>%</p><p>파괴 확률: <span id="refine-destroy-chance">-</span>%</p><p>비용: <span class="cost" id="refine-current-gold-cost">-</span></p></div>
                <div id="safe-refine-info"><h4>안전 강화</h4><p>성공 확률: <span id="refine-safe-success-chance">-</span>%</p><p>실패(유지) 확률: <span id="refine-safe-failure-chance">-</span>%</p><p>파괴 확률: 0.00%</p><p>비용: <span class="cost" id="refine-safe-gold-cost">-</span></p></div>
            </div>
            <div class="button-container">
                <button class="action-button" id="refine-action-button-normal">강화</button>
                <button class="action-button" id="refine-action-button-safe" style="display: none;">안전 강화</button>
            </div>
            <div class="cumulative-cost-display" id="refine-cumulative-cost-display"><p>누적 소모 골드: <span id="refine-total-gold-cost">0</span></p></div>
        </div>

        <!-- 증폭 모드 -->
        <div id="amplify-mode-container" class="hidden">
            <div class="perks-container">
                 <div class="perk-item" id="amplify-autoticket-container"><input type="checkbox" id="amplify-autoticket-checkbox"><label for="amplify-autoticket-checkbox">증폭권 자동 사용</label></div>
                 <div class="perk-item" id="amplify-frenzy-container"><input type="checkbox" id="amplify-frenzy-checkbox"><label for="amplify-frenzy-checkbox">증폭 대란 자동 발동</label></div>
            </div>
            <div class="image-box" id="amplify-image-box"><img id="amplify-item-image" src="" alt="아이템 이미지"></div>
            <div class="level-display amplify" id="amplify-level-display">+0</div>
            <div class="info-grid-container">
                <div id="normal-amplify-info"><h4>일반 증폭</h4><p>성공 확률: <span id="amplify-success-chance">-</span>%</p><p>실패 확률: <span id="amplify-failure-chance">-</span>%</p><p>파괴 확률: <span id="amplify-destroy-chance">-</span>%</p><p>비용: <span class="cost" id="amplify-current-cost">-</span></p></div>
                <div id="safe-amplify-info"><h4>안전 증폭</h4><p>성공 확률: <span id="amplify-safe-success-chance">-</span>%</p><p>실패(유지) 확률: <span id="amplify-safe-failure-chance">-</span>%</p><p>파괴 확률: 0.00%</p><p>비용: <span class="cost" id="amplify-safe-cost">-</span></p></div>
            </div>
            <div class="button-container">
                <button class="action-button" id="amplify-action-button-normal">증폭</button>
                <button class="action-button" id="amplify-action-button-safe" style="display: none;">안전 증폭</button>
            </div>
            <div class="cumulative-cost-display" id="amplify-cumulative-cost-display">
                <p>누적 소모 골드: <span id="amplify-total-gold-cost">0</span></p>
                <p>누적 소모 모순의 결정체: <span id="amplify-total-crystal-cost">0</span></p>
            </div>
        </div>
    </div>
    <div id="tooltip"></div>

    <script>
        let state = {
            currentMode: 'refine',
            currentUser: '비회원',
            refine: { userLevel: 1, currentXp: 0, nextLevelXp: 0, userPerk: '혜택 없음', nextUserPerk: '혜택 없음', userTickets: {}, hasUnlockedSecret: false, levelData: [], currentLevel: 0, totalGold: 0, isDestroyed: false, data: [], bonusChances: {}, safeBonusChances: {}, secretCostPaid: false },
            amplify: { userLevel: 1, currentXp: 0, nextLevelXp: 0, userPerk: '혜택 없음', nextUserPerk: '혜택 없음', userTickets: {}, levelData: [], currentLevel: 0, totalGold: 0, totalCrystals: 0, isDestroyed: false, data: [], bonusChances: {}, safeBonusChances: {}, isFrenzyActive: false }
        };
        let isActionInProgress = false;

        const dom = {
            container: document.getElementById('simulator-container'), userDisplayContainer: document.getElementById('user-display-container'), username: document.getElementById('username-display'), tooltip: document.getElementById('tooltip'), refineBtn: document.getElementById('refine-btn'), amplifyBtn: document.getElementById('amplify-btn'), refineModeContainer: document.getElementById('refine-mode-container'), amplifyModeContainer: document.getElementById('amplify-mode-container'),
            refine: { secretContainer: document.getElementById('secret-container'), secretCheckbox: document.getElementById('secret-checkbox'), costumeContainer: document.getElementById('costume-container'), costumeCheckbox: document.getElementById('costume-checkbox'), autoticketContainer: document.getElementById('autoticket-container'), autoticketCheckbox: document.getElementById('autoticket-checkbox'), level: document.getElementById('refine-level-display'), image: document.getElementById('refine-item-image'), imageBox: document.getElementById('refine-image-box'), normalButton: document.getElementById('refine-action-button-normal'), safeButton: document.getElementById('refine-action-button-safe'), successChance: document.getElementById('refine-success-chance'), failureChance: document.getElementById('refine-failure-chance'), destroyChance: document.getElementById('refine-destroy-chance'), currentGold: document.getElementById('refine-current-gold-cost'), safeSuccessChance: document.getElementById('refine-safe-success-chance'), safeFailureChance: document.getElementById('refine-safe-failure-chance'), safeGold: document.getElementById('refine-safe-gold-cost'), totalGold: document.getElementById('refine-total-gold-cost'), cumulativeCost: document.getElementById('refine-cumulative-cost-display'), safeInfo: document.getElementById('safe-refine-info') },
            amplify: { autoticketContainer: document.getElementById('amplify-autoticket-container'), autoticketCheckbox: document.getElementById('amplify-autoticket-checkbox'), frenzyContainer: document.getElementById('amplify-frenzy-container'), frenzyCheckbox: document.getElementById('amplify-frenzy-checkbox'), level: document.getElementById('amplify-level-display'), image: document.getElementById('amplify-item-image'), imageBox: document.getElementById('amplify-image-box'), normalButton: document.getElementById('amplify-action-button-normal'), safeButton: document.getElementById('amplify-action-button-safe'), successChance: document.getElementById('amplify-success-chance'), failureChance: document.getElementById('amplify-failure-chance'), destroyChance: document.getElementById('amplify-destroy-chance'), currentCost: document.getElementById('amplify-current-cost'), safeSuccessChance: document.getElementById('amplify-safe-success-chance'), safeFailureChance: document.getElementById('amplify-safe-failure-chance'), safeCost: document.getElementById('amplify-safe-cost'), totalGold: document.getElementById('amplify-total-gold-cost'), totalCrystals: document.getElementById('amplify-total-crystal-cost'), cumulativeCost: document.getElementById('amplify-cumulative-cost-display'), safeInfo: document.getElementById('safe-amplify-info') }
        };

        const calculateXp = (level) => level < 12 ? 0 : Math.pow(3, level - 12);
        const calculateAmpXp = (level) => { if (level < 10) return 0; if (level === 10) return 1; if (level === 11) return 2; if (level === 12) return 5; return 5 * Math.pow(3, level - 12); };
        const getRefineImagePath = (level) => { if (level <= 4) return '0004.png'; if (level <= 9) return '0509.png'; if (level <= 12) return '1012.png'; if (level === 13) return '1313.png'; if (level === 14) return '1414.png'; if (level === 15) return '1515.png'; if (level === 16) return '1616.png'; return '1717.png'; };
        const getAmplifyImagePath = (level) => { if (level <= 3) return '0003.png'; if (level <= 7) return '0407.png'; if (level <= 9) return '0809.png'; if (level === 10) return '1010.png'; if (level === 11) return '1111.png'; if (level === 12) return '1212.png'; if (level === 13) return '1313.png'; return '1414.png'; };
        const flashEffect = (type) => { dom.container.classList.add(`${type}-flash`); setTimeout(() => dom.container.classList.remove(`${type}-flash`), 500); };
        function showTooltip(content, element) { dom.tooltip.innerHTML = content; dom.tooltip.style.display = 'block'; const rect = element.getBoundingClientRect(); dom.tooltip.style.left = `${rect.left}px`; dom.tooltip.style.top = `${rect.bottom + 5}px`; }
        function hideTooltip() { dom.tooltip.style.display = 'none'; }

        function switchMode(mode) {
            state.currentMode = mode;
            if (mode === 'refine') {
                dom.refineModeContainer.classList.remove('hidden');
                dom.amplifyModeContainer.classList.add('hidden');
                dom.refineBtn.style.backgroundColor = '#e9e9e9';
                dom.amplifyBtn.style.backgroundColor = '#ffffff';
            } else {
                dom.refineModeContainer.classList.add('hidden');
                dom.amplifyModeContainer.classList.remove('hidden');
                dom.refineBtn.style.backgroundColor = '#ffffff';
                dom.amplifyBtn.style.backgroundColor = '#e9e9e9';
            }
            updateUserDisplay(); updateUI();
        }

        function updateUserDisplay() {
            const mode = state.currentMode;
            const userState = state[mode];
            const modeText = mode === 'refine' ? '강화' : '증폭';
            dom.username.textContent = `${state.currentUser}(${modeText} Lv.${userState.userLevel})`;
            const content = `<h4>현재 혜택</h4><p>${userState.userPerk}</p><br><h4>다음 레벨 혜택</h4><p>${userState.nextUserPerk}</p><hr><p>(${userState.currentXp.toLocaleString()}/${userState.nextLevelXp.toLocaleString()} XP)</p>`;
            dom.userDisplayContainer.onmouseover = () => showTooltip(content, dom.userDisplayContainer);
            dom.userDisplayContainer.onmouseout = hideTooltip;
        }

        function updateUI() {
            if (state.currentMode === 'refine') updateRefineUI();
            else updateAmplifyUI();
        }

        function updateRefineUI() {
            const S = state.refine; const D = dom.refine;
            if (S.isDestroyed) {
                const finalLevelText = `(최종 강화 : +${S.currentLevel})`;
                D.level.innerHTML = `<span class="final-level-text">${finalLevelText}</span><br>DESTROYED`;
                D.level.classList.add('destroyed'); D.imageBox.style.display = 'none'; D.normalButton.textContent = '재시도'; D.safeButton.style.display = 'none'; D.cumulativeCost.classList.add('destroyed-style');
                D.normalButton.disabled = false;
                return;
            }
            D.secretContainer.style.display = S.hasUnlockedSecret ? 'flex' : 'none';
            D.costumeContainer.style.display = S.userLevel >= 7 ? 'flex' : 'none';
            D.autoticketContainer.style.display = S.userLevel >= 6 ? 'block' : 'none';
            D.cumulativeCost.classList.remove('destroyed-style'); D.level.classList.remove('destroyed'); D.imageBox.style.display = 'flex'; D.normalButton.textContent = '강화'; D.level.textContent = `+${S.currentLevel}`;
            D.image.src = `images/upgrade/01/${getRefineImagePath(S.currentLevel)}`;
            const data = S.data.find(row => parseInt(row[0]) === S.currentLevel);
            if (data) {
                const secretBonus = D.secretCheckbox.checked ? 1 : 0, costumeBonus = D.costumeCheckbox.checked ? 1 : 0;
                const baseSuccess = parseFloat(data[1] || 0), bonusSuccess = S.bonusChances[S.currentLevel] || 0, actualSuccess = baseSuccess + bonusSuccess + secretBonus + costumeBonus, cost = parseInt(data[2] || 0), penalty = parseInt(data[3] || 0), isDestructible = penalty === -100, failure = 100 - Math.min(100, actualSuccess);
                D.successChance.textContent = Math.min(100, actualSuccess).toFixed(2); D.failureChance.textContent = isDestructible ? '0.00' : failure.toFixed(2); D.destroyChance.textContent = isDestructible ? failure.toFixed(2) : '0.00';
                D.currentGold.textContent = cost.toLocaleString();
                D.normalButton.disabled = false;
                if (isSafeRefineUnlocked(S.currentLevel, S.userLevel)) {
                    const safeCost = parseInt(data[6]);
                    const safeBaseSuccess = parseFloat(data[7] || 0), safeBonusSuccess = S.safeBonusChances[S.currentLevel] || 0, safeActualSuccess = safeBaseSuccess + safeBonusSuccess + secretBonus + costumeBonus, safeFailure = 100 - Math.min(100, safeActualSuccess);
                    D.safeSuccessChance.textContent = Math.min(100, safeActualSuccess).toFixed(2); D.safeFailureChance.textContent = safeFailure.toFixed(2); D.safeGold.textContent = safeCost.toLocaleString();
                    D.safeInfo.style.visibility = 'visible'; D.safeButton.style.display = 'block'; D.safeButton.disabled = false;
                } else {
                    D.safeInfo.style.visibility = 'hidden'; D.safeButton.style.display = 'none';
                }
            } else {
                 D.normalButton.disabled = true; D.safeButton.style.display = 'none';
            }
            D.totalGold.textContent = S.totalGold.toLocaleString();
        }

        function updateAmplifyUI() {
            const S = state.amplify; const D = dom.amplify;
            if (S.isDestroyed) {
                const finalLevelText = `(최종 증폭 : +${S.currentLevel})`;
                D.level.innerHTML = `<span class="final-level-text">${finalLevelText}</span><br>DESTROYED`;
                D.level.classList.add('destroyed'); D.imageBox.style.display = 'none'; D.normalButton.textContent = '재시도'; D.safeButton.style.display = 'none'; D.cumulativeCost.classList.add('destroyed-style');
                D.normalButton.disabled = false;
                return;
            }
            D.autoticketContainer.style.display = S.userLevel >= 6 ? 'block' : 'none';
            D.frenzyContainer.style.display = S.userLevel >= 7 ? 'block' : 'none';
            D.cumulativeCost.classList.remove('destroyed-style'); D.level.classList.remove('destroyed'); D.imageBox.style.display = 'flex'; D.normalButton.textContent = '증폭'; D.level.textContent = `+${S.currentLevel}`;
            D.image.src = `images/upgrade/02/${getAmplifyImagePath(S.currentLevel)}`;
            const data = S.data.find(row => parseInt(row[0]) === S.currentLevel);
            if (data) {
                const baseSuccess = parseFloat(data[1] || 0), bonusSuccess = S.bonusChances[S.currentLevel] || 0, actualSuccess = baseSuccess + bonusSuccess;
                const goldCost = parseInt(data[2] || 0), crystalCost = parseInt(data[4] || 0);
                const penalty = parseInt(data[3] || 0), isDestructible = penalty === -100, failure = 100 - Math.min(100, actualSuccess);
                D.successChance.textContent = Math.min(100, actualSuccess).toFixed(2); D.failureChance.textContent = isDestructible ? '0.00' : failure.toFixed(2); D.destroyChance.textContent = isDestructible ? failure.toFixed(2) : '0.00';
                D.currentCost.textContent = `${goldCost.toLocaleString()} + 모순${crystalCost}`;
                D.normalButton.disabled = false;
                if (isSafeAmplifyUnlocked(S.currentLevel, S.userLevel) && S.currentLevel < 10) {
                    let safeGoldCost = parseInt(data[6] || 0);
                    let safeBaseSuccess = parseFloat(data[7] || 0);
                    let safeBonusSuccess = S.safeBonusChances[S.currentLevel] || 0;
                    let safeActualSuccess = safeBaseSuccess + safeBonusSuccess;
                    if (S.isFrenzyActive) {
                        D.safeButton.textContent = '안전 증폭(증폭 대란!)';
                        if (S.currentLevel <= 6) { safeActualSuccess = 100; } 
                        else if (S.currentLevel >= 7 && S.currentLevel <= 9) { safeActualSuccess += 10; }
                    } else {
                        D.safeButton.textContent = '안전 증폭';
                    }
                    D.safeSuccessChance.textContent = Math.min(100, safeActualSuccess).toFixed(2); D.safeFailureChance.textContent = (100 - Math.min(100, safeActualSuccess)).toFixed(2);
                    D.safeCost.textContent = `${safeGoldCost.toLocaleString()}`;
                    D.safeInfo.style.visibility = 'visible'; D.safeButton.style.display = 'block'; D.safeButton.disabled = false;
                } else {
                    D.safeInfo.style.visibility = 'hidden'; D.safeButton.style.display = 'none';
                }
            } else {
                D.normalButton.disabled = true; D.safeButton.style.display = 'none';
            }
            D.totalGold.textContent = S.totalGold.toLocaleString(); D.totalCrystals.textContent = S.totalCrystals.toLocaleString();
        }

        async function submitRefineRanking() { if (state.currentUser === '비회원') return; try { await fetch('/.netlify/functions/addRank', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ nickname: state.currentUser, level: state.refine.currentLevel, gold: state.refine.totalGold, password: '0305' }) }); await fetchAllUserProfiles(); } catch (e) { console.error('Rank submission error:', e); } }
        async function submitAmplifyRanking() { if (state.currentUser === '비회원') return; try { await fetch('/.netlify/functions/addAmpRank', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ nickname: state.currentUser, level: state.amplify.currentLevel, gold: state.amplify.totalGold, crystals: state.amplify.totalCrystals, password: '0305' }) }); await fetchAllUserProfiles(); } catch (e) { console.error('Amplify Rank submission error:', e); } }
        
        async function fetchAllUserProfiles() {
            if (state.currentUser === '비회원') {
                recalculateRefineLevelForGuest();
                recalculateAmplifyLevelForGuest();
                return;
            }
            await Promise.all([fetchRefineUserProfile(), fetchAmplifyUserProfile()]);
        }

        async function fetchRefineUserProfile() { try { const res = await fetch(`/.netlify/functions/sheets?query=getUserProfile&nickname=${encodeURIComponent(state.currentUser)}`); const data = await res.json(); state.refine.userLevel = data.level || 1; state.refine.currentXp = data.currentXp || 0; state.refine.nextLevelXp = data.nextLevelXp || 0; state.refine.userPerk = data.perk || '혜택 없음'; state.refine.nextUserPerk = data.nextPerk || '최고 레벨'; state.refine.userTickets = data.tickets || {}; if (state.refine.userLevel >= 3) state.refine.hasUnlockedSecret = true; updateUserDisplay(); } catch (e) { console.error('Could not fetch refine profile:', e); } }
        async function fetchAmplifyUserProfile() { try { const res = await fetch(`/.netlify/functions/sheets?query=getAmpUserProfile&nickname=${encodeURIComponent(state.currentUser)}`); const data = await res.json(); state.amplify.userLevel = data.level || 1; state.amplify.currentXp = data.currentXp || 0; state.amplify.nextLevelXp = data.nextLevelXp || 0; state.amplify.userPerk = data.perk || '혜택 없음'; state.amplify.nextUserPerk = data.nextPerk || '최고 레벨'; state.amplify.userTickets = data.tickets || {}; updateUserDisplay(); } catch (e) { console.error('Could not fetch amplify profile:', e); } }

        function handleRefine(isSafe) {
            if (isActionInProgress) return; if (state.refine.isDestroyed) { resetSimulator('refine'); return; }
            isActionInProgress = true; dom.refine.normalButton.disabled = true; dom.refine.safeButton.disabled = true;
            const S = state.refine; const D = dom.refine; const startingLevel = S.currentLevel; let wasSuccess = false;
            if (D.secretCheckbox.checked && !S.secretCostPaid) { S.totalGold += 35000; S.secretCostPaid = true; }
            const data = S.data.find(row => parseInt(row[0]) === S.currentLevel);
            if (!data) { isActionInProgress = false; return; }
            const secretBonus = D.secretCheckbox.checked ? 1 : 0, costumeBonus = D.costumeCheckbox.checked ? 1 : 0;
            let successChance, cost, penalty, correctionChance;
            if (isSafe) { cost = parseInt(data[6] || 0); successChance = (parseFloat(data[7] || 0) + (S.safeBonusChances[S.currentLevel] || 0)) + secretBonus + costumeBonus; correctionChance = parseFloat(data[8] || 0); } 
            else { cost = parseInt(data[2] || 0); successChance = (parseFloat(data[1] || 0) + (S.bonusChances[S.currentLevel] || 0)) + secretBonus + costumeBonus; penalty = parseInt(data[3] || 0); correctionChance = parseFloat(data[4] || 0); }
            S.totalGold += cost;
            if (Math.random() * 100 < successChance) {
                wasSuccess = true; flashEffect('success');
                if (isSafe) S.safeBonusChances[S.currentLevel] = 0; else S.bonusChances[S.currentLevel] = 0;
                S.currentLevel++;
            } else {
                wasSuccess = false;
                if (isSafe) { flashEffect('failure'); S.safeBonusChances[S.currentLevel] = (S.safeBonusChances[S.currentLevel] || 0) + correctionChance; } 
                else { if (penalty === -100) { flashEffect('destroyed'); if (S.currentLevel >= 12) { S.hasUnlockedSecret = true; if (state.currentUser === '비회원') { S.currentXp += calculateXp(S.currentLevel); recalculateRefineLevelForGuest(); } } S.isDestroyed = true; submitRefineRanking(); } else { flashEffect('failure'); S.bonusChances[S.currentLevel] = (S.bonusChances[S.currentLevel] || 0) + correctionChance; S.currentLevel = Math.max(0, S.currentLevel - Math.abs(penalty)); } }
            }
            updateRefineUI();
            const cooldown = (wasSuccess && startingLevel >= 11) ? 1000 : 500;
            setTimeout(() => { isActionInProgress = false; updateUI(); }, cooldown);
        }

        function handleAmplify(isSafe) {
            if (isActionInProgress) return; if (state.amplify.isDestroyed) { resetSimulator('amplify'); return; }
            isActionInProgress = true; dom.amplify.normalButton.disabled = true; dom.amplify.safeButton.disabled = true;
            const S = state.amplify; const startingLevel = S.currentLevel; let wasSuccess = false;
            const data = S.data.find(row => parseInt(row[0]) === S.currentLevel);
            if (!data) { isActionInProgress = false; return; }
            let successChance, goldCost, crystalCost, penalty, correctionChance;
            if (isSafe) { goldCost = parseInt(data[6] || 0); crystalCost = 0; successChance = parseFloat(data[7] || 0) + (S.safeBonusChances[S.currentLevel] || 0); if (S.isFrenzyActive) { if (S.currentLevel <= 6) { successChance = 100; } else if (S.currentLevel >= 7 && S.currentLevel <= 9) { successChance += 10; } } correctionChance = parseFloat(data[8] || 0); penalty = 0; } 
            else { goldCost = parseInt(data[2] || 0); crystalCost = parseInt(data[4] || 0); successChance = parseFloat(data[1] || 0) + (S.bonusChances[S.currentLevel] || 0); penalty = parseInt(data[3] || 0); }
            S.totalGold += goldCost; S.totalCrystals += crystalCost;
            if (Math.random() * 100 < successChance) {
                wasSuccess = true; flashEffect('success');
                if (isSafe) S.safeBonusChances[S.currentLevel] = 0; else S.bonusChances[S.currentLevel] = 0;
                S.currentLevel++;
            } else {
                wasSuccess = false;
                if (penalty === -100) {
                    flashEffect('destroyed'); 
                    if (dom.amplify.frenzyCheckbox.checked) {
                        const userLevelData = S.levelData.find(row => parseInt(row[0]) === S.userLevel);
                        const frenzyChance = userLevelData ? parseFloat(userLevelData[7] || 0) : 0;
                        if (Math.random() * 100 < frenzyChance) { S.isFrenzyActive = true; }
                    }
                    if (state.currentUser === '비회원') { S.currentXp += calculateAmpXp(S.currentLevel); recalculateAmplifyLevelForGuest(); } 
                    S.isDestroyed = true; 
                    submitAmplifyRanking(); 
                } 
                else { flashEffect('failure'); if (isSafe) { S.safeBonusChances[S.currentLevel] = (S.safeBonusChances[S.currentLevel] || 0) + correctionChance; } else { S.currentLevel = Math.max(0, S.currentLevel + penalty); } }
            }
            updateAmplifyUI();
            const cooldown = (wasSuccess && startingLevel >= 10) ? 1000 : 500;
            setTimeout(() => { isActionInProgress = false; updateUI(); }, cooldown);
        }

        function resetSimulator(mode) {
            const targetMode = mode || state.currentMode;
            if (targetMode === 'refine') {
                state.refine = { ...state.refine, currentLevel: 0, totalGold: 0, isDestroyed: false, bonusChances: {}, safeBonusChances: {}, secretCostPaid: false };
                if (dom.refine.autoticketCheckbox.checked) { handleRefineAutoTicket(); }
            } else {
                state.amplify = { ...state.amplify, currentLevel: 0, totalGold: 0, totalCrystals: 0, isDestroyed: false, bonusChances: {}, safeBonusChances: {}, isFrenzyActive: false };
                if (dom.amplify.autoticketCheckbox.checked) { handleAmplifyAutoTicket(); }
            }
            updateUI();
        }

        async function initialize() {
            state.currentUser = sessionStorage.getItem('simulatorUser') || '비회원';
            try {
                const [refineRes, amplifyRes, refineLevelRes, amplifyLevelRes] = await Promise.all([ fetch(`/.netlify/functions/sheets?sheetName=강화확률`), fetch(`/.netlify/functions/sheets?sheetName=증폭확률`), fetch(`/.netlify/functions/sheets?sheetName=레벨`), fetch(`/.netlify/functions/sheets?sheetName=레벨2`) ]);
                state.refine.data = (await refineRes.json()).data;
                state.amplify.data = (await amplifyRes.json()).data;
                state.refine.levelData = (await refineLevelRes.json()).data;
                state.amplify.levelData = (await amplifyLevelRes.json()).data;
                await fetchAllUserProfiles();
                switchMode('refine');
            } catch (error) { console.error("Failed to load spreadsheet data:", error); }
        }
        
        dom.refineBtn.addEventListener('click', () => switchMode('refine'));
        dom.amplifyBtn.addEventListener('click', () => switchMode('amplify'));
        dom.refine.normalButton.addEventListener('click', () => handleRefine(false));
        dom.refine.safeButton.addEventListener('click', () => handleRefine(true));
        dom.refine.secretCheckbox.addEventListener('change', updateRefineUI);
        dom.refine.costumeCheckbox.addEventListener('change', updateRefineUI);
        dom.amplify.normalButton.addEventListener('click', () => handleAmplify(false));
        dom.amplify.safeButton.addEventListener('click', () => handleAmplify(true));
        dom.amplify.autoticketCheckbox.addEventListener('change', updateAmplifyUI);
        dom.amplify.frenzyCheckbox.addEventListener('change', updateAmplifyUI);
        
        const isSafeRefineUnlocked = (currentRefineLevel, userLvl) => { const data = state.refine.data.find(row => parseInt(row[0]) === currentRefineLevel); const safeCost = data && data[6] ? String(data[6]).trim() : ''; if (safeCost === '') return false; if (userLvl < 3) return false; if (userLvl === 3 && currentRefineLevel > 9) return false; if (userLvl === 4 && currentRefineLevel > 10) return false; return true; };
        const isSafeAmplifyUnlocked = (currentAmpLevel, userAmpLvl) => { if (userAmpLvl < 2) return false; if (userAmpLvl === 2 && currentAmpLevel > 6) return false; if (userAmpLvl === 3 && currentAmpLevel > 7) return false; if (userAmpLvl === 4 && currentAmpLevel > 8) return false; return true; };
        
        const recalculateRefineLevelForGuest = () => { const S = state.refine; let newLevel = 1, newPerk = '혜택 없음', newNextPerk = '혜택 없음', newNextXp = 0; if (S.levelData.length > 0) { newPerk = S.levelData[0][2] || '혜택 없음'; newNextXp = parseInt(S.levelData[0][1]) || 1; if (S.levelData.length > 1) newNextPerk = S.levelData[1][2] || '혜택 없음'; } for (let i = 0; i < S.levelData.length; i++) { const level = parseInt(S.levelData[i][0]); const requiredXp = parseInt(S.levelData[i][1]); if (S.currentXp >= requiredXp) { newLevel = level; newPerk = S.levelData[i][2] || '혜택 없음'; if (i + 1 < S.levelData.length) { newNextXp = parseInt(S.levelData[i+1][1]); newNextPerk = S.levelData[i+1][2] || '혜택 없음'; } else { newNextXp = requiredXp; newNextPerk = '최고 레벨'; } } else { newNextXp = requiredXp; newNextPerk = S.levelData[i][2] || '혜택 없음'; break; } } S.userLevel = newLevel; S.userPerk = newPerk; S.nextUserPerk = newNextPerk; S.nextLevelXp = newNextXp; updateUserDisplay(); };
        const recalculateAmplifyLevelForGuest = () => { const S = state.amplify; let newLevel = 1, newPerk = '혜택 없음', newNextPerk = '혜택 없음', newNextXp = 0; if (S.levelData.length > 0) { newPerk = S.levelData[0][2] || '혜택 없음'; newNextXp = parseInt(S.levelData[0][1]) || 1; if (S.levelData.length > 1) newNextPerk = S.levelData[1][2] || '혜택 없음'; } for (let i = 0; i < S.levelData.length; i++) { const level = parseInt(S.levelData[i][0]); const requiredXp = parseInt(S.levelData[i][1]); if (S.currentXp >= requiredXp) { newLevel = level; newPerk = S.levelData[i][2] || '혜택 없음'; if (i + 1 < S.levelData.length) { newNextXp = parseInt(S.levelData[i+1][1]); newNextPerk = S.levelData[i+1][2] || '혜택 없음'; } else { newNextXp = requiredXp; newNextPerk = '최고 레벨'; } } else { newNextXp = requiredXp; newNextPerk = S.levelData[i][2] || '혜택 없음'; break; } } S.userLevel = newLevel; S.userPerk = newPerk; S.nextUserPerk = newNextPerk; S.nextLevelXp = newNextXp; updateUserDisplay(); };
        
        const handleRefineAutoTicket = () => { const S = state.refine; const ticketChances = [S.userTickets.plus12, S.userTickets.plus11, S.userTickets.plus10, S.userTickets.plus7]; const ticketCosts = [77000000, 17500000, 7000000, 650000]; const targetLevels = [12, 11, 10, 7]; let ticketSucceeded = false; for (let i = 0; i < ticketChances.length; i++) { const chance = parseFloat(ticketChances[i] || 0); if (chance > 0) { S.totalGold += ticketCosts[i] * (chance / 100); if (Math.random() * 100 < chance) { S.currentLevel = targetLevels[i]; flashEffect('ticket-success'); ticketSucceeded = true; break; } } } if (!ticketSucceeded) { S.currentLevel = 0; } };
        const handleAmplifyAutoTicket = () => { const S = state.amplify; const ticketChances = [S.userTickets.plus12, S.userTickets.plus11, S.userTickets.plus10, S.userTickets.plus7]; const ticketCosts = [530000000, 166000000, 47000000, 5800000]; const targetLevels = [12, 11, 10, 7]; let ticketSucceeded = false; for (let i = 0; i < ticketChances.length; i++) { const chance = parseFloat(ticketChances[i] || 0); if (chance > 0) { S.totalGold += ticketCosts[i] * (chance / 100); if (Math.random() * 100 < chance) { S.currentLevel = targetLevels[i]; flashEffect('ticket-success'); ticketSucceeded = true; break; } } } if (!ticketSucceeded) { S.currentLevel = 0; } };

        const secretLabel = document.querySelector('label[for="secret-checkbox"]');
        secretLabel.addEventListener('mouseover', (e) => showTooltip('강화의 비밀 아이템을 사용하여 장비 강화의 성공 확률을 1%p만큼 증가시킵니다. 사용시 35,000골드가 소비됩니다.', secretLabel));
        secretLabel.addEventListener('mouseout', hideTooltip);
        const costumeLabel = document.querySelector('label[for="costume-checkbox"]');
        costumeLabel.addEventListener('mouseover', (e) => showTooltip('화덕 변신 코스튬을 사용하면 장비 강화의 성공 확률이 1%p만큼 증가합니다.', costumeLabel));
        costumeLabel.addEventListener('mouseout', hideTooltip);
        const autoticketLabel = document.querySelector('label[for="autoticket-checkbox"]');
        autoticketLabel.addEventListener('mouseover', (e) => showTooltip('사용 가능한 강화권 중 고강화권을 우선적으로 모두 사용합니다. 최초 1회만 적용됩니다.', autoticketLabel));
        autoticketLabel.addEventListener('mouseout', hideTooltip);
        const ampAutoticketLabel = document.querySelector('label[for="amplify-autoticket-checkbox"]');
        ampAutoticketLabel.addEventListener('mouseover', (e) => showTooltip('사용 가능한 증폭권 중 고증폭권을 우선적으로 모두 사용합니다. 최초 1회만 적용됩니다.', ampAutoticketLabel));
        ampAutoticketLabel.addEventListener('mouseout', hideTooltip);

        initialize();
    </script>
</body>
</html>