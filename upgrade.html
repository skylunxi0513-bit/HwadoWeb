<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>강화/증폭 시뮬레이터 - 화도웹</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .simulator-container {
            width: 100%;
            max-width: 400px; 
            margin: 20px auto;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
            transition: background-color 0.1s ease-in-out;
        }
        .simulator-container.success-flash { background-color: #a8e6a8; }
        .simulator-container.failure-flash { background-color: #e6a8a8; }
        .simulator-container.destroyed-flash { background-color: #cccccc; }
        
        .user-display-container {
            position: relative;
        }
        .user-display {
            text-align: right;
            margin-bottom: 15px;
            font-size: 14px;
            color: #555;
            cursor: help;
        }
        .mode-selector { margin-bottom: 10px; }
        .mode-selector button { width: 120px; }
        
        #secret-container {
            margin-bottom: 20px;
            display: none; 
        }
        .image-box {
            width: 100%;
            height: 200px; 
            border: 2px dashed #ccc;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f9f9f9;
            overflow: hidden; 
        }
        .image-box img {
            max-width: 100%;
            max-height: 100%;
            transform: scale(2.5); 
        }
        .level-display {
            font-size: 48px;
            font-weight: bold;
            color: #007bff;
            margin-bottom: 20px;
        }
        .level-display.destroyed { color: #888; }
        
        .info-grid {
            display: flex;
            justify-content: space-between;
            text-align: left;
            margin-bottom: 20px;
            padding: 0 10px;
        }
        .probability-display p, .current-cost-display p { margin: 5px 0; }
        .current-cost-display { text-align: right; }
        
        .action-button {
            width: 100%;
            padding: 15px;
            font-size: 20px;
            margin-bottom: 20px;
        }
        .cumulative-cost-display {
            font-size: 16px;
            color: #555;
            border-top: 1px solid #eee;
            padding-top: 15px;
            transition: all 0.2s ease-in-out;
        }
        .cumulative-cost-display.destroyed-style { font-size: 20px; font-weight: bold; }

        #user-tooltip {
            position: absolute;
            background-color: #333;
            color: #fff;
            padding: 10px;
            border-radius: 5px;
            z-index: 1000;
            text-align: left;
            min-width: 250px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            bottom: 100%;
            right: 0;
            margin-bottom: 5px;
            display: none; /* Hidden by default */
        }
        #user-tooltip.hidden { display: none; }
        #user-tooltip h4 {
            margin: 0 0 8px 0;
            font-size: 14px;
            color: #f0f0f0;
            border-bottom: 1px solid #555;
            padding-bottom: 5px;
        }
        #user-tooltip p { margin: 0; font-size: 12px; }
    </style>
</head>
<body>
    <a href="index.html" class="header-link">
        <h1>화도웹</h1>
    </a>

    <div class="simulator-container" id="simulator-container">
        <div class="user-display-container">
            <div class="user-display" id="user-display">사용자: <span id="username-display"></span></div>
            <div id="user-tooltip"></div>
        </div>

        <div class="mode-selector">
            <button id="refine-btn">강화</button>
            <button id="amplify-btn" disabled>증폭</button>
        </div>

        <div id="secret-container">
            <input type="checkbox" id="secret-checkbox">
            <label for="secret-checkbox">강화의 비밀</label>
        </div>

        <div class="image-box" id="image-box">
            <img id="item-image" src="" alt="아이템 이미지">
        </div>

        <div class="level-display" id="level-display">+0</div>

        <div class="info-grid">
            <div class="probability-display">
                <p>성공 확률: <span id="success-chance">-</span>%</p>
                <p>실패 확률: <span id="failure-chance">-</span>%</p>
                <p>파괴 확률: <span id="destroy-chance">-</span>%</p>
            </div>
            <div class="current-cost-display">
                <p><span id="current-gold-cost">-</span> 골드</p>
            </div>
        </div>

        <button class="action-button" id="action-button">강화</button>

        <div class="cumulative-cost-display" id="cumulative-cost-display">
            <p>누적 소모 골드: <span id="total-gold-cost">0</span></p>
        </div>
    </div>

    <script>
        // --- STATE ---
        let currentLevel = 0, totalGold = 0, isDestroyed = false;
        let refineData = [], levelData = [];
        let bonusChances = {};
        let currentUser = '비회원', userLevel = 0, currentXp = 0, nextLevelXp = 0, userPerk = '혜택 없음';
        let hasUnlockedSecret = false, secretCostPaid = false;

        // --- DOM Elements ---
        const dom = {
            container: document.getElementById('simulator-container'),
            userDisplay: document.getElementById('user-display'),
            username: document.getElementById('username-display'),
            tooltip: document.getElementById('user-tooltip'),
            secretContainer: document.getElementById('secret-container'),
            secretCheckbox: document.getElementById('secret-checkbox'),
            level: document.getElementById('level-display'),
            image: document.getElementById('item-image'),
            imageBox: document.getElementById('image-box'),
            actionButton: document.getElementById('action-button'),
            successChance: document.getElementById('success-chance'),
            failureChance: document.getElementById('failure-chance'),
            destroyChance: document.getElementById('destroy-chance'),
            currentGold: document.getElementById('current-gold-cost'),
            totalGold: document.getElementById('total-gold-cost'),
            cumulativeCost: document.getElementById('cumulative-cost-display')
        };

        // --- LOGIC ---
        const calculateXp = (level) => level < 12 ? 0 : Math.pow(3, level - 12);

        function getImagePath(level) {
            if (level <= 4) return '0004.png';
            if (level <= 9) return '0509.png';
            if (level <= 12) return '1012.png';
            if (level === 13) return '1313.png';
            if (level === 14) return '1414.png';
            if (level === 15) return '1515.png';
            if (level === 16) return '1616.png';
            return '1717.png';
        }

        function flashEffect(type) {
            dom.container.classList.add(`${type}-flash`);
            setTimeout(() => dom.container.classList.remove(`${type}-flash`), 500);
        }

        function updateUserDisplay() {
            dom.username.innerHTML = `${currentUser}(Lv.${userLevel})`;
            dom.tooltip.innerHTML = `<h4>현재 혜택</h4><p>${userPerk}</p><p>(${currentXp}/${nextLevelXp} XP)</p>`;
        }

        function updateUI() {
            if (isDestroyed) {
                dom.level.textContent = 'DESTROYED';
                dom.level.classList.add('destroyed');
                dom.imageBox.style.display = 'none';
                dom.actionButton.textContent = '재시도';
                dom.successChance.textContent = '-';
                dom.failureChance.textContent = '-';
                dom.destroyChance.textContent = '-';
                dom.currentGold.textContent = '-';
                dom.cumulativeCost.classList.add('destroyed-style');
                return;
            }

            if (hasUnlockedSecret) dom.secretContainer.style.display = 'block';
            
            dom.cumulativeCost.classList.remove('destroyed-style');
            dom.level.classList.remove('destroyed');
            dom.imageBox.style.display = 'flex';
            dom.actionButton.textContent = '강화';
            dom.level.textContent = `+${currentLevel}`;
            dom.image.src = `images/upgrade/01/${getImagePath(currentLevel)}`;

            const data = refineData.find(row => parseInt(row[0]) === currentLevel);
            if (data) {
                const baseSuccess = parseFloat(data[1] || 0);
                const bonusSuccess = bonusChances[currentLevel] || 0;
                const secretBonus = dom.secretCheckbox.checked ? 1 : 0;
                const actualSuccess = baseSuccess + bonusSuccess + secretBonus;
                const cost = parseInt(data[2] || 0);
                const penalty = parseInt(data[3] || 0);
                const isDestructible = penalty === -100;
                const failure = 100 - Math.min(100, actualSuccess);

                dom.successChance.textContent = Math.min(100, actualSuccess).toFixed(2);
                dom.failureChance.textContent = isDestructible ? '0.00' : failure.toFixed(2);
                dom.destroyChance.textContent = isDestructible ? failure.toFixed(2) : '0.00';
                dom.currentGold.textContent = cost.toLocaleString();
                dom.actionButton.disabled = false;
            } else {
                dom.successChance.textContent = '0.00';
                dom.failureChance.textContent = '0.00';
                dom.destroyChance.textContent = '0.00';
                dom.currentGold.textContent = '-';
                dom.actionButton.disabled = true;
            }
            dom.totalGold.textContent = totalGold.toLocaleString();
        }

        async function submitRanking() {
            if (currentUser === '비회원') return;
            try {
                await fetch('/.netlify/functions/addRank', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ nickname: currentUser, level: currentLevel, gold: totalGold, password: '0305' })
                });
                // After submitting, refresh profile to get new XP and Level
                await fetchUserProfile(); 
            } catch (error) {
                console.error('Rank submission error:', error);
            }
        }

        function recalculateLevelForGuest() {
            let newLevelInfo = { currentLevel: 0, perk: '혜택 없음', nextLevelXp: 0 };
            let tempXp = currentXp;

            for (let i = 0; i < levelData.length; i++) {
                const level = parseInt(levelData[i][0]);
                const requiredXp = parseInt(levelData[i][1]);
                if (tempXp >= requiredXp) {
                    newLevelInfo.currentLevel = level;
                    newLevelInfo.perk = levelData[i][2] || '혜택 없음';
                } else {
                    newLevelInfo.nextLevelXp = requiredXp;
                    break;
                }
                if (i === levelData.length - 1) newLevelInfo.nextLevelXp = requiredXp;
            }
            userLevel = newLevelInfo.currentLevel;
            userPerk = newLevelInfo.perk;
            nextLevelXp = newLevelInfo.nextLevelXp;
            updateUserDisplay();
        }

        function handleRefine() {
            if (isDestroyed) { resetSimulator(); return; }
            if (dom.secretCheckbox.checked && !secretCostPaid) {
                totalGold += 35000;
                secretCostPaid = true;
            }

            const data = refineData.find(row => parseInt(row[0]) === currentLevel);
            if (!data) return;

            const baseSuccess = parseFloat(data[1] || 0), bonusSuccess = bonusChances[currentLevel] || 0, secretBonus = dom.secretCheckbox.checked ? 1 : 0;
            const actualSuccess = baseSuccess + bonusSuccess + secretBonus;
            const cost = parseInt(data[2] || 0), penalty = parseInt(data[3] || 0), correctionChance = parseFloat(data[4] || 0);
            totalGold += cost;

            if (Math.random() * 100 < actualSuccess) {
                flashEffect('success');
                bonusChances[currentLevel] = 0;
                currentLevel++;
            } else {
                if (penalty === -100) {
                    flashEffect('destroyed');
                    if (currentLevel >= 12) {
                        hasUnlockedSecret = true;
                        if (currentUser === '비회원') {
                            currentXp += calculateXp(currentLevel);
                            recalculateLevelForGuest();
                        }
                    }
                    isDestroyed = true;
                    submitRanking();
                } else {
                    flashEffect('failure');
                    bonusChances[currentLevel] = (bonusChances[currentLevel] || 0) + correctionChance;
                    currentLevel = Math.max(0, currentLevel - Math.abs(penalty));
                }
            }
            updateUI();
        }

        function resetSimulator() {
            currentLevel = 0; totalGold = 0; isDestroyed = false; bonusChances = {}; secretCostPaid = false;
            dom.actionButton.disabled = false;
            updateUI();
        }

        async function fetchUserProfile() {
            if (currentUser === '비회원') {
                const levelInfo = levelData.length > 0 ? levelData[0] : [1, 0];
                nextLevelXp = parseInt(levelInfo[1], 10);
                updateUserDisplay();
                return;
            }
            try {
                const res = await fetch(`/.netlify/functions/sheets?query=getUserProfile&nickname=${encodeURIComponent(currentUser)}`);
                const data = await res.json();
                userLevel = data.level; currentXp = data.currentXp; nextLevelXp = data.nextLevelXp; userPerk = data.perk;
                if (userLevel > 0) hasUnlockedSecret = true; // Assumption: Any level unlocks it
                updateUserDisplay();
            } catch (e) { console.error('Could not fetch user profile:', e); }
        }

        async function initialize() {
            currentUser = sessionStorage.getItem('simulatorUser') || '비회원';
            try {
                const [refineRes, levelRes] = await Promise.all([
                    fetch(`/.netlify/functions/sheets?sheetName=강화확률`),
                    fetch(`/.netlify/functions/sheets?sheetName=레벨`)
                ]);
                const refineResult = await refineRes.json();
                const levelResult = await levelRes.json();
                refineData = refineResult.data;
                levelData = levelResult.data;
                
                await fetchUserProfile();
                resetSimulator();
            } catch (error) {
                console.error("Failed to load spreadsheet data:", error);
                dom.level.textContent = "오류";
            }
        }

        dom.secretCheckbox.addEventListener('change', updateUI);
        dom.actionButton.addEventListener('click', handleRefine);
        dom.userDisplay.addEventListener('mouseover', () => { dom.tooltip.style.display = 'block'; });
        dom.userDisplay.addEventListener('mouseout', () => { dom.tooltip.style.display = 'none'; });

        initialize();

    </script>
</body>
</html>
