<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>화도웹 - 카드 가격</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <a href="index.html" class="header-link">
        <h1>화도웹</h1>
    </a>

    <div class="enchant-buttons-container">
        <button id="dealer-btn">딜러</button>
        <button id="buffer-btn">버퍼</button>
    </div>

    <div id="enchant-main-container" class="hidden">
        <div id="left-container" class="enchant-sub-container">
            <div class="enchant-box"><div class="enchant-box-title">머리어깨</div><div class="items-wrapper"></div></div>
            <div class="enchant-box"><div class="enchant-box-title">상의</div><div class="items-wrapper"></div></div>
            <div class="enchant-box"><div class="enchant-box-title">하의</div><div class="items-wrapper"></div></div>
            <div class="enchant-box"><div class="enchant-box-title">벨트</div><div class="items-wrapper"></div></div>
            <div class="enchant-box"><div class="enchant-box-title">신발</div><div class="items-wrapper"></div></div>
            <div class="enchant-box transparent"></div>
            <div class="enchant-box transparent"></div>
            <div class="enchant-box transparent"></div>
        </div>
        <div id="right-container" class="enchant-sub-container">
            <div class="enchant-box"><div class="enchant-box-title">무기</div><div class="items-wrapper"></div></div>
            <div class="enchant-box transparent"></div>
            <div class="enchant-box"><div class="enchant-box-title">팔찌</div><div class="items-wrapper"></div></div>
            <div class="enchant-box"><div class="enchant-box-title">목걸이</div><div class="items-wrapper"></div></div>
            <div class="enchant-box"><div class="enchant-box-title">보조장비</div><div class="items-wrapper"></div></div>
            <div class="enchant-box"><div class="enchant-box-title">반지</div><div class="items-wrapper"></div></div>
            <div class="enchant-box"><div class="enchant-box-title">귀걸이</div><div class="items-wrapper"></div></div>
            <div class="enchant-box"><div class="enchant-box-title">마법석</div><div class="items-wrapper"></div></div>
        </div>
    </div>

    <div id="card-tooltip" class="hidden">
        <!-- Tooltip content will be dynamically loaded here -->
    </div>

    <script>
        const dealerBtn = document.getElementById('dealer-btn');
        const bufferBtn = document.getElementById('buffer-btn');
        const mainContainer = document.getElementById('enchant-main-container');
        const itemWrappers = Array.from(document.querySelectorAll('.enchant-box:not(.transparent) .items-wrapper'));
        const leftBoxes = Array.from(document.querySelectorAll('#left-container .enchant-box:not(.transparent)'));
        const rightBoxes = Array.from(document.querySelectorAll('#right-container .enchant-box:not(.transparent)'));
        const cardTooltip = document.getElementById('card-tooltip');

        let allItemsData = []; // To store all items for tooltip

        async function fetchSheetData(type) {
            const response = await fetch(`/.netlify/functions/sheets?sheetName=카드가격&filterColumn=2&filterValue=${encodeURIComponent(type)}`);
            if (!response.ok) throw new Error(`Sheets API Error: ${response.status}`);
            const result = await response.json();
            if (result.error) throw new Error(result.error);
            return result.data;
        }

        async function fetchPrice(itemName) {
            try {
                const response = await fetch(`/.netlify/functions/auction?itemName=${encodeURIComponent(itemName)}`);
                if (!response.ok) return Infinity;
                const data = await response.json();
                return (data.rows && data.rows.length > 0) ? data.rows[0].unitPrice : Infinity;
            } catch (error) {
                console.error(`Price fetch failed for ${itemName}:`, error);
                return Infinity;
            }
        }

        const fetchDataAndRender = async (type) => {
            mainContainer.classList.remove('hidden');
            itemWrappers.forEach(wrapper => { wrapper.innerHTML = '로딩 중...'; });

            try {
                const sheetRows = await fetchSheetData(type);

                const pricePromises = sheetRows.map(row => fetchPrice(row[3]).then(price => ({
                    boxIndex: parseInt(row[0], 10) || 0,
                    priority: parseInt(row[1], 10) || 0,
                    name: row[3] || '',
                    image: row[4] || '',
                    price: price
                })));
                
                allItemsData = await Promise.all(pricePromises); // Store all items

                const groupedByBox = allItemsData.reduce((acc, item) => {
                    if (!acc[item.boxIndex]) acc[item.boxIndex] = [];
                    acc[item.boxIndex].push(item);
                    return acc;
                }, {});

                for (const boxIndex in groupedByBox) {
                    const items = groupedByBox[boxIndex];
                    const processedItems = [];
                    const groupedByPriority = items.reduce((acc, item) => {
                        if (!acc[item.priority]) acc[item.priority] = [];
                        acc[item.priority].push(item);
                        return acc;
                    }, {});

                    const sortedPriorities = Object.keys(groupedByPriority).sort((a, b) => a - b);

                    for (const priority of sortedPriorities) {
                        const priorityGroup = groupedByPriority[priority];
                        if (priorityGroup.length > 0) {
                            const cheapestItem = priorityGroup.reduce((cheapest, current) => 
                                current.price < cheapest.price ? current : cheapest
                            );
                            processedItems.push(cheapestItem);
                        }
                    }
                    groupedByBox[boxIndex] = processedItems;
                }

                itemWrappers.forEach(wrapper => { wrapper.innerHTML = ''; });

                const boxMapping = {
                    '1': leftBoxes[0], '2': leftBoxes[1], '3': leftBoxes[2], '4': leftBoxes[3], '5': leftBoxes[4],
                    '6': rightBoxes[0], '7': rightBoxes[1], '8': rightBoxes[2], '9': rightBoxes[3], '10': rightBoxes[4], '11': rightBoxes[5], '12': rightBoxes[6]
                };

                for (const boxIndex in groupedByBox) {
                    const targetWrapper = boxMapping[boxIndex]?.querySelector('.items-wrapper');
                    if (targetWrapper) {
                        const items = groupedByBox[boxIndex];
                        items.forEach(item => {
                            const itemDiv = document.createElement('div');
                            itemDiv.className = 'card-item';
                            // Add data attributes for tooltip lookup
                            itemDiv.dataset.boxIndex = item.boxIndex;
                            itemDiv.dataset.priority = item.priority;
                            itemDiv.dataset.name = item.name; // Store name for exact match

                            const priceString = item.price === Infinity ? '매물 없음' : `${item.price.toLocaleString()} 골드`;
                            const imageTag = item.image ? `<img src="images/${item.image}" alt="${item.name}">` : '';

                            itemDiv.innerHTML = `
                                ${imageTag}
                                <span class="card-name">${item.name}</span>
                                <span class="card-price">${priceString}</span>
                            `;
                            targetWrapper.appendChild(itemDiv);
                        });
                    }
                }

            } catch (error) {
                console.error('Failed to fetch and render card data:', error);
                itemWrappers.forEach(wrapper => { wrapper.innerHTML = '오류 발생'; });
            }
        };

        dealerBtn.addEventListener('click', () => fetchDataAndRender('딜러'));
        bufferBtn.addEventListener('click', () => fetchDataAndRender('버퍼'));

        fetchDataAndRender('딜러'); // Auto-load dealer data on page load

        // --- Tooltip Logic ---
        function showTooltip(event) {
            console.log('showTooltip triggered');
            const hoveredItem = event.currentTarget;
            console.log('Hovered item:', hoveredItem);
            console.log('Hovered item dataset directly:', hoveredItem.dataset);
            const boxIndex = hoveredItem.dataset.boxIndex;
            const priority = hoveredItem.dataset.priority;
            const currentItemName = hoveredItem.dataset.name;

            console.log('showTooltip triggered for:', currentItemName);
            console.log('allItemsData:', allItemsData);

            const relatedItems = allItemsData.filter(item => 
                item.boxIndex === boxIndex && 
                item.priority === priority && 
                item.name !== currentItemName // Exclude the hovered item itself
            );

            console.log('Related items found:', relatedItems);

            if (relatedItems.length > 0) {
                let tooltipContent = '<h4>다른 매물</h4>';
                relatedItems.sort((a, b) => a.price - b.price); // Sort by price for display
                relatedItems.forEach(item => {
                    const priceString = item.price === Infinity ? '매물 없음' : `${item.price.toLocaleString()} 골드`;
                    tooltipContent += `<p>${item.name}: ${priceString}</p>`;
                });
                cardTooltip.innerHTML = tooltipContent;
                cardTooltip.classList.remove('hidden');

                console.log('Tooltip content:', tooltipContent);

                // Position the tooltip
                const rect = hoveredItem.getBoundingClientRect();
                cardTooltip.style.left = `${rect.right + 10}px`;
                cardTooltip.style.top = `${rect.top}px`;
                console.log('Tooltip position:', cardTooltip.style.left, cardTooltip.style.top);
            } else {
                cardTooltip.classList.add('hidden');
                console.log('No related items found, hiding tooltip.');
            }
        }

        function hideTooltip() {
            console.log('hideTooltip triggered');
            cardTooltip.classList.add('hidden');
        }

        // Attach event listeners after items are rendered
        mainContainer.addEventListener('mouseover', (event) => {
            const cardItemElement = event.target.closest('.card-item'); // Get the actual card-item
            if (cardItemElement) {
                showTooltip(cardItemElement); // Pass the card-item element directly
            }
        });
        mainContainer.addEventListener('mouseout', (event) => {
            const cardItemElement = event.target.closest('.card-item'); // Get the actual card-item
            if (cardItemElement) { // Only hide if we were hovering over a card-item
                hideTooltip(cardItemElement); // Pass the card-item element directly
            }
        });

    </script>
</body>
</html>