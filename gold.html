<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>단서/잔흔 계산기 - 화도웹</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <a href="index.html" class="header-link">
        <h1>화도웹</h1>
    </a>

    <div class="calculator-container">
        <div class="calc-section">
            <div class="options-grid">
                <label>형상화된 요기의 단서:</label>
                <input type="number" id="clue-price" class="expectation-value" value="0" min="0">

                <label>교환 가능 요기의 잔흔:</label>
                <input type="number" id="trace-price" class="expectation-value" value="0" min="0">
            </div>
        </div>

        <div class="calc-section">
            <div class="options-grid">
                <label>단서 판매시:</label>
                <div id="a-value" class="expectation-value">0 골드</div>

                <label>요괴 섬멸(5000):</label>
                <div id="b-value" class="expectation-value">0 골드</div>

                <label id="d-label">요괴 섬멸(c):</label>
                <div id="d-value" class="expectation-value">0 골드</div>
            </div>
        </div>

        <div class="calc-section">
            <div class="options-grid">
                <label for="target-trace-count">목표 잔흔:</label>
                <input type="number" id="target-trace-count" value="0" min="0">
                <div></div> <!-- Empty div for alignment -->
                <div></div> <!-- Empty div for alignment -->

                <label>직접 구매시:</label>
                <div id="h-value" class="expectation-value">0 골드</div>

                <label>필요 형상화된 요기의 단서:</label>
                <div id="f-value" class="expectation-value">0 개</div>

                <label>단서 구매시:</label>
                <div id="i-value" class="expectation-value">0 골드</div>
            </div>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const cluePriceInput = document.getElementById('clue-price');
        const tracePriceInput = document.getElementById('trace-price');
        const aValueDisplay = document.getElementById('a-value');
        const bValueDisplay = document.getElementById('b-value');
        const dLabel = document.getElementById('d-label');
        const dValueDisplay = document.getElementById('d-value');
        const targetTraceCountInput = document.getElementById('target-trace-count');
        const hValueDisplay = document.getElementById('h-value');
        const fValueDisplay = document.getElementById('f-value');
        const iValueDisplay = document.getElementById('i-value');

        // --- Helper to fetch price ---
        async function fetchItemPrice(itemName) {
            try {
                const response = await fetch(`/.netlify/functions/auction?itemName=${encodeURIComponent(itemName)}`);
                if (!response.ok) throw new Error(`API 서버 응답 오류: ${response.status}`);
                const data = await response.json();
                if (data.rows && data.rows.length > 0) {
                    return data.rows[0].unitPrice;
                }
                return 0; // Item not found
            } catch (error) {
                console.error(`가격 조회 실패 (${itemName}):`, error);
                return 0; // Error fetching
            }
        }

        // --- Main Calculation Function ---
        function calculateAndDisplay() {
            const currentCluePrice = parseInt(cluePriceInput.value) || 0;
            const currentTracePrice = parseInt(tracePriceInput.value) || 0;

            // Dynamically update the label for '요괴 섬멸(c)'
            dLabel.innerHTML = `요괴 섬멸(${currentTracePrice.toLocaleString('en-US')}):`;

            // Calculations
            const a = currentCluePrice * 0.97;
            const b = 389288 + currentTracePrice * 2.89;
            const d = 258643 + currentTracePrice * 29.019;

            const e = parseInt(targetTraceCountInput.value) || 0;
            const f = e / 29.019;
            const h = e * currentTracePrice;
            const i = f * currentCluePrice;
            const j = f * 258643;

            // Update displays
            aValueDisplay.innerHTML = `${Math.round(a).toLocaleString('en-US')} 골드`;
            bValueDisplay.innerHTML = `${Math.round(b).toLocaleString('en-US')} 골드`;
            dValueDisplay.innerHTML = `${Math.round(d).toLocaleString('en-US')} 골드`;
            hValueDisplay.innerHTML = `${Math.round(h).toLocaleString('en-US')} 골드`;
            fValueDisplay.innerHTML = `${Math.ceil(f).toLocaleString('en-US')} 개`;
            iValueDisplay.innerHTML = `${Math.round(i).toLocaleString('en-US')} 골드<br>(${Math.round(j).toLocaleString('en-US')} 골드 회수)`;
        }

        // --- Initial Load & Event Listeners ---
        async function initialize() {
            const itemNames = [
                '형상화된 요기의 단서',
                '요기의 잔흔(1회 교환 가능)'
            ];

            const [fetchedCluePrice, fetchedTracePrice] = await Promise.all(
                itemNames.map(fetchItemPrice)
            );

            cluePriceInput.value = fetchedCluePrice;
            tracePriceInput.value = fetchedTracePrice;

            // Add event listeners to the new input fields
            cluePriceInput.addEventListener('input', calculateAndDisplay);
            tracePriceInput.addEventListener('input', calculateAndDisplay);
            targetTraceCountInput.addEventListener('input', calculateAndDisplay);

            calculateAndDisplay(); // Initial calculation
        }

        initialize();
    </script>

</body>
</html>