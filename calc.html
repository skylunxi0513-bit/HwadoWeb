<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>확률 계산기 - 화도웹</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .calculator-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            font-size: 1.2em;
            max-width: 800px;
            margin: 0 auto;
        }
        .calculator-container select,
        .calculator-container input {
            padding: 8px;
            font-size: 1em;
            border-radius: 5px;
            border: 1px solid #555;
            background-color: #333;
            color: #fff;
        }
        .input-group {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        #result {
            font-size: 2.5em;
            font-weight: bold;
            color: #c56eff; /* 보라색 */
            text-align: center;
            margin-top: 20px;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <a href="index.html" class="header-link">
        <h1>화도웹</h1>
    </a>

    <div class="calculator-container">
        <div class="input-group">
            <select id="location">
                <option value="1">헬</option>
                <option value="1">주시</option>
                <option value="13">심숭이</option>
                <option value="3">흰구</option>
                <option value="5">솔리</option>
                <option value="7">호수</option>
                <option value="10">애쥬</option>
                <option value="11">여신</option>
                <option value="12">흉몽</option>
                <option value="8">베누스</option>
                <option value="11">나벨</option>
                <option value="11">이내</option>
            </select>
            <label>를</label>
            <input type="number" id="runs" value="1" min="1">
            <label>판 돌려서</label>
        </div>

        <div id="luck-section" class="input-group hidden">
            <label>행운이</label>
            <select id="luck-type">
                <option value="none">안터지고</option>
                <option value="once">1번 터진판이</option>
                <option value="twice">2번 터진판이</option>
            </select>
            <div id="luck-runs-container" class="hidden">
                <input type="number" id="luck-runs" value="1" min="1">
                <label>판</label>
            </div>
        </div>

        <div class="input-group">
            <select id="item-rarity">
                <option value="0.2503">레어</option>
                <option value="0.19692">유니크</option>
                <option value="0.03649">레전</option>
                <option value="0.01756">에픽</option>
                <option value="0.00160" selected>태초</option>
            </select>
            <div id="item-subtype-container" class="input-group hidden">
                 <select id="item-subtype">
                    <option value="1">아무거나</option>
                    <option value="7">무기</option>
                    <option value="14">자무기</option>
                    <option value="28">자거시</option>
                </select>
            </div>
            <label>를</label>
            <input type="number" id="item-count" value="1" min="1">
            <label>개 먹을 확률은?</label>
        </div>

        <div id="result">0.0000%</div>
    </div>

    <script>
        // --- DOM Elements ---
        const locationSelect = document.getElementById('location');
        const runsInput = document.getElementById('runs');
        const luckSection = document.getElementById('luck-section');
        const luckTypeSelect = document.getElementById('luck-type');
        const luckRunsContainer = document.getElementById('luck-runs-container');
        const luckRunsInput = document.getElementById('luck-runs');
        const itemRaritySelect = document.getElementById('item-rarity');
        const itemSubtypeContainer = document.getElementById('item-subtype-container');
        const itemSubtypeSelect = document.getElementById('item-subtype');
        const itemCountInput = document.getElementById('item-count');
        const resultDiv = document.getElementById('result');

        // --- Helper Functions for Probability ---
        const memoize = (fn) => {
            const cache = {};
            return (...args) => {
                const key = JSON.stringify(args);
                if (cache[key]) {
                    return cache[key];
                }
                const result = fn(...args);
                cache[key] = result;
                return result;
            };
        };

        const combinations = memoize((n, k) => {
            if (k < 0 || k > n) return 0;
            if (k === 0 || k === n) return 1;
            if (k > n / 2) k = n - k;
            let res = 1;
            for (let i = 1; i <= k; i++) {
                res = res * (n - i + 1) / i;
            }
            return res;
        });

        function binomialProb(n, k, p) {
            if (p < 0 || p > 1) return 0;
            return combinations(n, k) * Math.pow(p, k) * Math.pow(1 - p, n - k);
        }

        function atLeastBinomialProb(n, k, p) {
            if (k > n) return 0;
            let cumulativeProb = 0;
            for (let i = 0; i < k; i++) {
                cumulativeProb += binomialProb(n, i, p);
            }
            return 1 - cumulativeProb;
        }

        // --- Main Calculation Logic ---
        function calculateProbability() {
            const locationMultiplier = parseInt(locationSelect.value);
            const runs = parseInt(runsInput.value);
            const desiredCount = parseInt(itemCountInput.value);

            let multiplier = locationMultiplier * runs;
            let luckProbModifier = 1.0;

            // 행운 섹션 처리
            if (locationSelect.options[locationSelect.selectedIndex].text === '헬') {
                const luckType = luckTypeSelect.value;
                if (luckType !== 'none') {
                    const luckRuns = parseInt(luckRunsInput.value);
                    if (luckType === 'once') {
                        multiplier += 14;
                        luckProbModifier = atLeastBinomialProb(runs, luckRuns, 0.00336);
                    } else if (luckType === 'twice') {
                        multiplier += 49;
                        luckProbModifier = atLeastBinomialProb(runs, luckRuns, 0.00046);
                    }
                }
            }

            // 아이템 드랍 확률 처리
            let baseProb = parseFloat(itemRaritySelect.value);
            const rarityText = itemRaritySelect.options[itemRaritySelect.selectedIndex].text;
            if (rarityText === '에픽' || rarityText === '태초') {
                const subtypeDivisor = parseInt(itemSubtypeSelect.value);
                baseProb /= subtypeDivisor;
            }

            // 최종 확률 계산
            if (desiredCount > multiplier) {
                resultDiv.textContent = '0.0000000000%';
                return;
            }
            
            const finalProb = atLeastBinomialProb(multiplier, desiredCount, baseProb) * luckProbModifier;
            
            resultDiv.textContent = (finalProb * 100).toFixed(10) + '%';
        }

        // --- UI Update Logic ---
        function updateUI() {
            const locationText = locationSelect.options[locationSelect.selectedIndex].text;
            const rarityText = itemRaritySelect.options[itemRaritySelect.selectedIndex].text;
            const luckType = luckTypeSelect.value;

            // 행운 섹션 보이기/숨기기
            if (locationText === '헬') {
                luckSection.classList.remove('hidden');
            } else {
                luckSection.classList.add('hidden');
            }
            
            // 행운 판수 입력칸 보이기/숨기기
            if (luckType === 'once' || luckType === 'twice') {
                luckRunsContainer.classList.remove('hidden');
            } else {
                luckRunsContainer.classList.add('hidden');
            }

            // 아이템 서브타입 섹션 보이기/숨기기
            if (rarityText === '에픽' || rarityText === '태초') {
                itemSubtypeContainer.classList.remove('hidden');
            } else {
                itemSubtypeContainer.classList.add('hidden');
            }
            
            calculateProbability();
        }

        // --- Event Listeners ---
        [locationSelect, runsInput, luckTypeSelect, luckRunsInput, itemRaritySelect, itemSubtypeSelect, itemCountInput].forEach(element => {
            element.addEventListener('change', updateUI);
        });

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', updateUI);

    </script>
</body>
</html>
