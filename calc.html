<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>기댓값 계산기 - 화도웹</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .calculator-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            font-size: 1.2em;
            max-width: 800px;
            margin: 0 auto;
            text-align: center; /* Center align all lines */
        }
        .calculator-container select,
        .calculator-container input[type="number"] {
            padding: 8px;
            font-size: 1em;
            border-radius: 5px;
            border: 1px solid #ccc;
            background-color: #fff; /* 흰색 배경 */
            color: #000; /* 검은색 글씨 */
            width: 120px; /* Default width for selects and number inputs */
            max-width: 100%; /* Ensure responsiveness */
        }
        /* Specific width for smaller number inputs */
        #runs, #luck-runs, #item-count {
            width: 80px;
        }
        /* New styles for dropdowns that need more width */
        #luck-type { /* For "2번 터진판이" */
            width: 150px; /* Increased width */
        }
        #item-subtype { /* For "아무거나" */
            width: 150px; /* Increased width */
        }
        .input-group {
            display: flex;
            align-items: center;
            justify-content: center; /* Center items within input-group */
            gap: 10px;
            flex-wrap: wrap;
        }
        #result-container {
            text-align: center;
            margin-top: 20px;
        }
        #result {
            font-size: 2.5em;
            font-weight: bold;
            color: #ff4d4d; /* 빨간색 */
        }
        #expected-runs {
            font-size: 0.8em;
            color: #aaa;
            margin-top: 5px;
        }
        #lottery-comparison {
            font-size: 0.8em;
            color: #aaa;
            margin-top: 5px;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <a href="index.html" class="header-link">
        <h1>화도웹</h1>
    </a>

    <div class="calculator-container">
        <h2>기댓값 계산기</h2>
        <div class="input-group">
            <select id="location">
                <option value="1">헬</option>
                <option value="1">주시</option>
                <option value="13">심숭이</option>
                <option value="3">흰구</option>
                <option value="5">솔리</option>
                <option value="7">호수</option>
                <option value="10">애쥬</option>
                <option value="11">여신</option>
                <option value="12">흉몽</option>
                <option value="8">베누스</option>
                <option value="11">나벨</option>
                <option value="11">이내</option>
            </select>
            <label>를</label>
            <input type="number" id="runs" value="1" min="1">
            <label>판 돌려서</label>
        </div>

        <div id="luck-section" class="input-group hidden">
            <label>행운</label>
            <select id="luck-type">
                <option value="none">상관 없이</option>
                <option value="once">1번 터진판이</option>
                <option value="twice">2번 터진판이</option>
            </select>
            <div id="luck-runs-container" class="hidden">
                <label>최소</label>
                <input type="number" id="luck-runs" value="1" min="1">
                <label>판</label>
            </div>
        </div>

        <div class="input-group">
            <select id="item-rarity">
                <option value="0.2503">레어</option>
                <option value="0.19692">유니크</option>
                <option value="0.03649">레전</option>
                <option value="0.01756">에픽</option>
                <option value="0.00160" selected>태초</option>
            </select>
            <div id="item-subtype-container" class="input-group hidden">
                 <select id="item-subtype">
                    <option value="1">아무거나</option>
                    <option value="7">무기</option>
                    <option value="14">자무기</option>
                    <option value="28">자무기 레거시</option>
                </select>
                <label>를</label>
            </div>
            <input type="number" id="item-count" value="1" min="1">
            <select id="probability-type">
                <option value="atLeast" selected>이상</option>
                <option value="exactly">정확히</option>
                <option value="lessThan">미만</option>
            </select>
            <label>개 먹을 확률은?</label>
        </div>

        <div id="result-container">
            <div id="result">0.0000%</div>
            <div id="expected-runs"></div>
            <div id="lottery-comparison"></div> <!-- New div for lottery comparison -->
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const locationSelect = document.getElementById('location');
        const runsInput = document.getElementById('runs');
        const luckSection = document.getElementById('luck-section');
        const luckTypeSelect = document.getElementById('luck-type');
        const luckRunsContainer = document.getElementById('luck-runs-container');
        const luckRunsInput = document.getElementById('luck-runs');
        const itemRaritySelect = document.getElementById('item-rarity');
        const itemSubtypeContainer = document.getElementById('item-subtype-container');
        const itemSubtypeSelect = document.getElementById('item-subtype');
        const itemCountInput = document.getElementById('item-count');
        const probabilityTypeSelect = document.getElementById('probability-type');
        const resultDiv = document.getElementById('result');
        const expectedRunsDiv = document.getElementById('expected-runs');
        const lotteryComparisonDiv = document.getElementById('lottery-comparison'); // New DOM element reference

        // --- Constants ---
        const LOTTERY_PROBABILITY = 1 / 8145060; // 1 in 8,145,060 for 6/45 lottery

        // --- Helper Functions for Probability ---
        const memoize = (fn) => {
            const cache = {};
            return (...args) => {
                const key = JSON.stringify(args);
                if (cache[key]) return cache[key];
                return cache[key] = fn(...args);
            };
        };

        const combinations = memoize((n, k) => {
            if (k < 0 || k > n) return 0;
            if (k === 0 || k === n) return 1;
            if (k > n / 2) k = n - k;
            let res = 1;
            for (let i = 1; i <= k; i++) {
                res = res * (n - i + 1) / i;
            }
            return res;
        });

        function binomialProb(n, k, p) {
            if (p < 0 || p > 1) return 0;
            return combinations(n, k) * Math.pow(p, k) * Math.pow(1 - p, n - k);
        }

        function atLeastBinomialProb(n, k, p) {
            if (k > n) return 0;
            let cumulativeProb = 0;
            for (let i = 0; i < k; i++) {
                cumulativeProb += binomialProb(n, i, p);
            }
            return 1 - cumulativeProb;
        }

        function lessThanBinomialProb(n, k, p) {
            if (k <= 0) return 0; // Cannot have less than 0 successes
            if (k > n) k = n + 1; // If k is greater than n, it means less than or equal to n successes
            let cumulativeProb = 0;
            for (let i = 0; i < k; i++) {
                cumulativeProb += binomialProb(n, i, p);
            }
            return cumulativeProb;
        }

        // --- Main Calculation Logic ---
        function calculateProbability() {
            const locationMultiplier = parseInt(locationSelect.value);
            const runs = parseInt(runsInput.value);
            const desiredCount = parseInt(itemCountInput.value);
            const probabilityType = probabilityTypeSelect.value;

            let multiplier = locationMultiplier * runs;
            let luckProbModifier = 1.0;

            if (locationSelect.options[locationSelect.selectedIndex].text === '헬') {
                const luckType = luckTypeSelect.value;
                if (luckType !== 'none') {
                    const luckRuns = parseInt(luckRunsInput.value);
                    if (luckType === 'once') {
                        multiplier += 14;
                        luckProbModifier = atLeastBinomialProb(runs, luckRuns, 0.00336);
                    } else if (luckType === 'twice') {
                        multiplier += 49;
                        luckProbModifier = atLeastBinomialProb(runs, luckRuns, 0.00046);
                    }
                }
            }

            let baseProb = parseFloat(itemRaritySelect.value);
            const rarityText = itemRaritySelect.options[itemRaritySelect.selectedIndex].text;
            if (rarityText === '에픽' || rarityText === '태초') {
                const subtypeDivisor = parseInt(itemSubtypeSelect.value);
                baseProb /= subtypeDivisor;
            }

            let finalProb = 0;
            switch (probabilityType) {
                case 'atLeast':
                    if (desiredCount <= multiplier) {
                        finalProb = atLeastBinomialProb(multiplier, desiredCount, baseProb) * luckProbModifier;
                    }
                    break;
                case 'exactly':
                    if (desiredCount <= multiplier) {
                        finalProb = binomialProb(multiplier, desiredCount, baseProb) * luckProbModifier;
                    }
                    break;
                case 'lessThan':
                    if (desiredCount > 0) { // Cannot have less than 0 items
                        finalProb = lessThanBinomialProb(multiplier, desiredCount, baseProb) * luckProbModifier;
                    }
                    break;
            }

            // --- Display Logic ---
            resultDiv.style.fontSize = '2.5em'; // Reset font size
            lotteryComparisonDiv.textContent = ''; // Clear previous comparison

            if (finalProb === 0) {
                resultDiv.textContent = '불가능';
                expectedRunsDiv.textContent = '';
                return;
            }

            // 0.0000000000000002% is 2e-18
            if (finalProb > 0 && finalProb < 2e-18) {
                resultDiv.innerHTML = '계산 불가<span style="font-size: 0.6em;">(지나치게 낮음!)</span>';
                expectedRunsDiv.textContent = '';
            } else {
                if (finalProb * 100 < 0.0000000001) {
                    resultDiv.style.fontSize = '1.8em'; // Reduce font size
                    resultDiv.textContent = (finalProb * 100).toFixed(20) + '%';
                } else {
                    resultDiv.textContent = (finalProb * 100).toFixed(10) + '%';
                }
                const expected = Math.round(1 / finalProb);
                expectedRunsDiv.textContent = `(${expected.toLocaleString()}회 시도해서 성공할 확률)`;

                // Lottery Comparison Logic
                if (finalProb > 0) { // Only compare if finalProb is positive
                    let comparisonText = '';
                    if (finalProb > LOTTERY_PROBABILITY) {
                        const ratio = (finalProb / LOTTERY_PROBABILITY).toFixed(2);
                        comparisonText = `(로또 1등 확률보다 ${ratio}배 쉬움)`;
                    } else if (finalProb < LOTTERY_PROBABILITY) {
                        const ratio = (LOTTERY_PROBABILITY / finalProb).toFixed(2);
                        comparisonText = `(로또 1등 확률보다 ${ratio}배 어려움)`;
                    } else {
                        comparisonText = `(로또 1등 확률과 같음)`;
                    }
                    lotteryComparisonDiv.textContent = comparisonText;
                }
            }
        }

        // --- UI Update Logic ---
        function updateUI() {
            const locationText = locationSelect.options[locationSelect.selectedIndex].text;
            const rarityText = itemRaritySelect.options[itemRaritySelect.selectedIndex].text;
            const luckType = luckTypeSelect.value;

            luckSection.classList.toggle('hidden', locationText !== '헬');
            luckRunsContainer.classList.toggle('hidden', luckType === 'none');
            itemSubtypeContainer.classList.toggle('hidden', rarityText !== '에픽' && rarityText !== '태초');
            
            // Update "행운이 상관 없이" to "행운 상관 없이"
            const luckNoneOption = luckTypeSelect.querySelector('option[value="none"]');
            if (luckNoneOption) {
                luckNoneOption.textContent = '상관 없이'; // Changed from '행운이 상관 없이'
            }

            calculateProbability();
        }

        // --- Event Listeners ---
        [locationSelect, runsInput, luckTypeSelect, luckRunsInput, itemRaritySelect, itemSubtypeSelect, itemCountInput, probabilityTypeSelect].forEach(element => {
            element.addEventListener('change', updateUI);
        });

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', updateUI);

    </script>
</body>
</html>