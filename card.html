<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>카드첩 계산기 - 화도웹</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <a href="index.html">
        <h1>화도웹</h1>
    </a>

    <div class="main-buttons-container">
        <button id="venusBtn">
            <img src="images/card.webp" alt="베누스 카드첩 아이콘">
            베누스 카드첩
        </button>
        <button id="nabelBtn">
            <img src="images/card.webp" alt="나벨 카드첩 아이콘">
            나벨 카드첩
        </button>
        <button id="inaeBtn">
            <img src="images/card.webp" alt="이내 카드첩 아이콘">
            이내 카드첩
        </button>
        <button id="heugaBtn">
            <img src="images/ancient.webp" alt="흑아 태초 항아리 아이콘">
            흑아 태초 항아리
        </button>
        <button id="chanranNabelBtn">
            <img src="images/card.webp" alt="찬란한 나벨 카드첩 아이콘">
            찬란한 나벨 카드첩
        </button>
        <button id="historiaQuartzBtn">
            <img src="images/quartz.webp" alt="히스토리아 쿼츠 상자 아이콘">
            히스토리아 쿼츠 상자
        </button>
    </div>

    <div id="result-container"></div>

    <script>
        // --- DOM Elements ---
        const venusBtn = document.getElementById('venusBtn');
        const nabelBtn = document.getElementById('nabelBtn');
        const inaeBtn = document.getElementById('inaeBtn');
        const heugaBtn = document.getElementById('heugaBtn');
        const chanranNabelBtn = document.getElementById('chanranNabelBtn');
        const historiaQuartzBtn = document.getElementById('historiaQuartzBtn');
        const resultContainer = document.getElementById('result-container');

        // --- Item Lists ---
        const venusCardItems = [
            '황금의 광채 베누스 카드', '미의 여신 베누스 카드', '무결한 죽음 비시마 카드', '다정한 죽음 세니르 카드',
            '폭음 크래시머 카드', '일각수 크라켄 카드', '적아 울라드 카드', '땅지기 카메린 카드'
        ];
        const nabelCardItems = [
            '안개신의 무의식 카드', '황금의 광채 베누스 카드', '미의 여신 베누스 카드', '무결한 죽음 비시마 카드',
            '다정한 죽음 세니르 카드', '폭음 크래시머 카드', '일각수 크라켄 카드', '적아 울라드 카드', '땅지기 카메린 카드'
        ];
        const inaeCardItems = [
            '선별자 룬디어 카드', '더 파이퍼 카드', '파고드는 스펀저 카드', '역병을 담은 눈, 옴마 카드',
            '안개신의 무의식 카드', '황금의 광채 베누스 카드', '미의 여신 베누스 카드', '무결한 죽음 비시마 카드',
            '다정한 죽음 세니르 카드', '폭음 크래시머 카드', '일각수 크라켄 카드', '적아 울라드 카드', '땅지기 카메린 카드'
        ];
        const heugaPotItems = [
            '흑아 태초 변환서 - 그림자에 숨은 죽음', '흑아 태초 변환서 - 소울 페어리', '흑아 태초 변환서 - 영원히 이어지는 황금향',
            '흑아 태초 변환서 - 용투장의 난', '흑아 태초 변환서 - 칠흑의 정화', '흑아 태초 변환서 - 세렌디피티',
            '흑아 태초 변환서 - 한계를 넘어선 에너지', '흑아 태초 변환서 - 압도적인 자연', '흑아 태초 변환서 - 고대 전장의 발키리',
            '흑아 태초 변환서 - 에테리얼 오브 아츠', '흑아 태초 변환서 - 무리 사냥의 길잡이', '흑아 태초 변환서 - 마력의 영역'
        ];
        const chanranNabelCardItems = [
            '무지의 악 나벨 카드', '오만의 악 아니마 카드', '인공신 3호 나벨 카드', '인공신 2호 아니마 카드',
            '연구소장 엘디르 카드', '최후의 테아나 카드', '인공신 프로토타입 카드', '과학자 모리 카드'
        ];
        const historiaQuartzItems = [
            '히스토리아 쿼츠'
        ];

        // --- Reusable Core Logic ---
        async function fetchPrice(itemName) {
            try {
                const response = await fetch(`/.netlify/functions/auction?itemName=${encodeURIComponent(itemName)}`);
                if (!response.ok) return { name: itemName, price: 0 };
                const data = await response.json();
                return (data.rows && data.rows.length > 0) 
                    ? { name: itemName, price: data.rows[0].unitPrice } 
                    : { name: itemName, price: 0 };
            } catch (error) {
                console.error(`${itemName} 가격 조회 실패:`, error);
                return { name: itemName, price: 0 };
            }
        }

        async function calculateAndDisplay(itemList) {
            resultContainer.innerHTML = `<p>아이템 ${itemList.length}종의 최저가를 검색 중입니다...</p>`;
            try {
                const pricePromises = itemList.map(fetchPrice);
                const results = await Promise.all(pricePromises);
                const foundItems = results.filter(item => item.price > 0);

                if (foundItems.length === 0) {
                    resultContainer.innerHTML = `<p>모든 아이템의 매물을 찾을 수 없습니다.</p>`;
                    return;
                }

                foundItems.sort((a, b) => b.price - a.price);

                const totalPrice = foundItems.reduce((sum, item) => sum + item.price, 0);
                const averagePrice = totalPrice / foundItems.length;
                
                let breakEvenPoint;
                let baseAveragePrice = averagePrice;

                if (itemList === historiaQuartzItems) {
                    baseAveragePrice = averagePrice * 20;
                }

                if (itemList === heugaPotItems) {
                    breakEvenPoint = baseAveragePrice * 0.97;
                } else {
                    let coefficient;
                    if (itemList === chanranNabelCardItems || itemList === historiaQuartzItems) {
                        coefficient = 1.081;
                    } else {
                        coefficient = 1.2903;
                    }
                    breakEvenPoint = (baseAveragePrice * 0.97) / coefficient;
                }

                // --- Profit Probability Calculation ---
                let profitProbability;
                let probabilityNote;
                let profitableItemsCount = 0;

                if (itemList === heugaPotItems) {
                    const buyPrice = 3300000;
                    profitableItemsCount = foundItems.filter(item => (item.price * 0.97) > buyPrice).length;
                    probabilityNote = `※${buyPrice.toLocaleString('en-US')}골드로 구매했을 때 기준`;
                } else if (itemList === historiaQuartzItems) {
                    const outcomeValue = averagePrice * 20 * 0.97;
                    if (outcomeValue > breakEvenPoint) {
                        profitableItemsCount = 1;
                    }
                    probabilityNote = '※손익 분기점으로 구매했을 때 기준';
                } else { // For all other card packs
                    const buyPrice = breakEvenPoint;
                    profitableItemsCount = foundItems.filter(item => (item.price * 0.97) > buyPrice).length;
                    probabilityNote = '※손익 분기점으로 구매했을 때 기준';
                }

                profitProbability = (profitableItemsCount / foundItems.length) * 100;

                let tableHTML = '<div class="results-container"><table><thead><tr><th>아이템 이름</th><th>최저가</th></tr></thead><tbody>';
                foundItems.forEach(item => {
                    tableHTML += `<tr><td>${item.name}</td><td>${item.price.toLocaleString('en-US')} 골드</td></tr>`;
                });
                tableHTML += '</tbody></table></div>';

                let summaryHTML = `<div class="summary">
                    <div><strong>아이템 평균 가격:</strong> ${Math.round(averagePrice).toLocaleString('en-US')} 골드</div>
                    <div><strong>손익 분기점:</strong> ${Math.round(breakEvenPoint).toLocaleString('en-US')} 골드</div>
                    <div><strong>이득 볼 확률:</strong> ${profitProbability.toFixed(2)}%</div>
                    <div class="disclaimer">${probabilityNote}</div>
                </div>`;

                resultContainer.innerHTML = summaryHTML + tableHTML;
            } catch (error) {
                console.error('전체 작업 중 에러 발생:', error);
                resultContainer.innerHTML = `<p>데이터를 불러오는 중 오류가 발생했습니다.</p>`;
            }
        }

        // --- Event Listeners ---
        venusBtn.addEventListener('click', () => calculateAndDisplay(venusCardItems));
        nabelBtn.addEventListener('click', () => calculateAndDisplay(nabelCardItems));
        inaeBtn.addEventListener('click', () => calculateAndDisplay(inaeCardItems));
        heugaBtn.addEventListener('click', () => calculateAndDisplay(heugaPotItems));
        chanranNabelBtn.addEventListener('click', () => calculateAndDisplay(chanranNabelCardItems));
        historiaQuartzBtn.addEventListener('click', () => calculateAndDisplay(historiaQuartzItems));

    </script>

</body>
</html>