<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>카드첩 계산기 - 화도웹</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <a href="index.html">
        <h1>화도웹</h1>
    </a>

    <button id="venusBtn">
        <img src="images/card.webp" alt="베누스 카드첩 아이콘">
        베누스 카드첩
    </button>
    <button>
        <img src="images/card.webp" alt="나벨 카드첩 아이콘">
        나벨 카드첩
    </button>

    <div id="result-container"></div>

    <script>
        const venusBtn = document.getElementById('venusBtn');
        const resultContainer = document.getElementById('result-container');

        const cardItems = [
            '황금의 광채 베누스 카드',
            '미의 여신 베누스 카드',
            '무결한 죽음 비시마 카드',
            '다정한 죽음 세니르 카드',
            '폭음 크래시머 카드',
            '일각수 크라켄 카드',
            '적아 울라드 카드',
            '땅지기 카메린 카드'
        ];

        async function fetchPrice(itemName) {
            try {
                const response = await fetch(`/.netlify/functions/auction?itemName=${encodeURIComponent(itemName)}`);
                if (!response.ok) return { name: itemName, price: 0 };
                const data = await response.json();
                if (data.rows && data.rows.length > 0) {
                    return { name: itemName, price: data.rows[0].unitPrice };
                }
                return { name: itemName, price: 0 };
            } catch (error) {
                console.error(`${itemName} 가격 조회 실패:`, error);
                return { name: itemName, price: 0 };
            }
        }

        venusBtn.addEventListener('click', async () => {
            resultContainer.innerHTML = `<p>카드 8종의 최저가를 검색 중입니다...</p>`;

            try {
                const pricePromises = cardItems.map(fetchPrice);
                const results = await Promise.all(pricePromises);
                const foundItems = results.filter(item => item.price > 0);

                if (foundItems.length === 0) {
                    resultContainer.innerHTML = `<p>모든 아이템의 매물을 찾을 수 없습니다.</p>`;
                    return;
                }

                foundItems.sort((a, b) => b.price - a.price);

                const totalPrice = foundItems.reduce((sum, item) => sum + item.price, 0);
                const averagePrice = totalPrice / foundItems.length;
                const breakEvenPoint = (averagePrice * 0.97) / 1.2903;

                let tableHTML = '<div class="results-container"><table><thead><tr><th>아이템 이름</th><th>최저가</th></tr></thead><tbody>';
                foundItems.forEach(item => {
                    tableHTML += `<tr><td>${item.name}</td><td>${item.price.toLocaleString('en-US')} 골드</td></tr>`;
                });
                tableHTML += '</tbody></table></div>';

                let summaryHTML = `<div class="summary">
                    <div><strong>카드 평균 가격:</strong> ${Math.round(averagePrice).toLocaleString('en-US')} 골드</div>
                    <div><strong>손익 분기점:</strong> ${Math.round(breakEvenPoint).toLocaleString('en-US')} 골드</div>
                </div>`;

                // Display summary above the table
                resultContainer.innerHTML = summaryHTML + tableHTML;

            } catch (error) {
                console.error('전체 작업 중 에러 발생:', error);
                resultContainer.innerHTML = `<p>데이터를 불러오는 중 오류가 발생했습니다.</p>`;
            }
        });
    </script>

</body>
</html>