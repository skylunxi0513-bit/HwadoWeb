<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>카드첩 계산기 - 화도웹</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .button-container {
            margin-top: 40px; /* 헤더와 버튼 사이 간격 추가 */
        }
    </style>
</head>
<body>
    <a href="index.html">
        <h1>화도웹</h1>
    </a>

    <div class="button-container">
        <button id="venusBtn">
            <img src="images/card.webp" alt="베누스 카드첩 아이콘">
            베누스 카드첩
        </button>
        <button id="nabelBtn">
            <img src="images/card.webp" alt="나벨 카드첩 아이콘">
            나벨 카드첩
        </button>
        <button id="inaeBtn">
            <img src="images/card.webp" alt="이내 카드첩 아이콘">
            이내 카드첩
        </button>
        <button id="heugaBtn">
            <img src="images/ancient.webp" alt="흑아 태초 항아리 아이콘">
            흑아 태초 항아리
        </button>
    </div>

    <div id="result-container"></div>

    <script>
        // --- DOM Elements ---
        const venusBtn = document.getElementById('venusBtn');
        const nabelBtn = document.getElementById('nabelBtn');
        const inaeBtn = document.getElementById('inaeBtn');
        const heugaBtn = document.getElementById('heugaBtn');
        const resultContainer = document.getElementById('result-container');

        // --- Item Lists ---
        const venusCardItems = [
            '황금의 광채 베누스 카드', '미의 여신 베누스 카드', '무결한 죽음 비시마 카드', '다정한 죽음 세니르 카드',
            '폭음 크래시머 카드', '일각수 크라켄 카드', '적아 울라드 카드', '땅지기 카메린 카드'
        ];
        const nabelCardItems = [
            '안개신의 무의식 카드', '황금의 광채 베누스 카드', '미의 여신 베누스 카드', '무결한 죽음 비시마 카드',
            '다정한 죽음 세니르 카드', '폭음 크래시머 카드', '일각수 크라켄 카드', '적아 울라드 카드', '땅지기 카메린 카드'
        ];
        const inaeCardItems = [
            '선별자 룬디어 카드', '더 파이퍼 카드', '파고드는 스펀저 카드', '역병을 담은 눈, 옴마 카드',
            '안개신의 무의식 카드', '황금의 광채 베누스 카드', '미의 여신 베누스 카드', '무결한 죽음 비시마 카드',
            '다정한 죽음 세니르 카드', '폭음 크래시머 카드', '일각수 크라켄 카드', '적아 울라드 카드', '땅지기 카메린 카드'
        ];
        const heugaPotItems = [
            '흑아 태초 변환서 - 그림자에 숨은 죽음', '흑아 태초 변환서 - 소울 페어리', '흑아 태초 변환서 - 영원히 이어지는 황금향',
            '흑아 태초 변환서 - 용투장의 난', '흑아 태초 변환서 - 칠흑의 정화', '흑아 태초 변환서 - 세렌디피티',
            '흑아 태초 변환서 - 한계를 넘어선 에너지', '흑아 태초 변환서 - 압도적인 자연', '흑아 태초 변환서 - 고대 전장의 발키리',
            '흑아 태초 변환서 - 에테리얼 오브 아츠', '흑아 태초 변환서 - 무리 사냥의 길잡이', '흑아 태초 변환서 - 마력의 영역'
        ];

        // --- Reusable Core Logic ---
        async function fetchPrice(itemName) {
            try {
                const response = await fetch(`/.netlify/functions/auction?itemName=${encodeURIComponent(itemName)}`);
                if (!response.ok) return { name: itemName, price: 0 };
                const data = await response.json();
                return (data.rows && data.rows.length > 0) 
                    ? { name: itemName, price: data.rows[0].unitPrice } 
                    : { name: itemName, price: 0 };
            } catch (error) {
                console.error(`${itemName} 가격 조회 실패:`, error);
                return { name: itemName, price: 0 };
            }
        }

        async function calculateAndDisplay(itemList) {
            resultContainer.innerHTML = `<p>아이템 ${itemList.length}종의 최저가를 검색 중입니다...</p>`;
            try {
                const pricePromises = itemList.map(fetchPrice);
                const results = await Promise.all(pricePromises);
                const foundItems = results.filter(item => item.price > 0);

                if (foundItems.length === 0) {
                    resultContainer.innerHTML = `<p>모든 아이템의 매물을 찾을 수 없습니다.</p>`;
                    return;
                }

                foundItems.sort((a, b) => b.price - a.price);

                const totalPrice = foundItems.reduce((sum, item) => sum + item.price, 0);
                const averagePrice = totalPrice / foundItems.length;
                let breakEvenPoint;
                if (itemList === heugaPotItems) {
                    breakEvenPoint = averagePrice * 0.97;
                } else {
                    breakEvenPoint = (averagePrice * 0.97) / 1.2903;
                }

                let tableHTML = '<div class="results-container"><table><thead><tr><th>아이템 이름</th><th>최저가</th></tr></thead><tbody>';
                foundItems.forEach(item => {
                    tableHTML += `<tr><td>${item.name}</td><td>${item.price.toLocaleString('en-US')} 골드</td></tr>`;
                });
                tableHTML += '</tbody></table></div>';

                let summaryHTML = `<div class="summary">
                    <div><strong>아이템 평균 가격:</strong> ${Math.round(averagePrice).toLocaleString('en-US')} 골드</div>
                    <div><strong>손익 분기점:</strong> ${Math.round(breakEvenPoint).toLocaleString('en-US')} 골드</div>
                </div>`;

                resultContainer.innerHTML = summaryHTML + tableHTML;
            } catch (error) {
                console.error('전체 작업 중 에러 발생:', error);
                resultContainer.innerHTML = `<p>데이터를 불러오는 중 오류가 발생했습니다.</p>`;
            }
        }

        // --- Event Listeners ---
        venusBtn.addEventListener('click', () => calculateAndDisplay(venusCardItems));
        nabelBtn.addEventListener('click', () => calculateAndDisplay(nabelCardItems));
        inaeBtn.addEventListener('click', () => calculateAndDisplay(inaeCardItems));
        heugaBtn.addEventListener('click', () => calculateAndDisplay(heugaPotItems));

    </script>

</body>
</html>
